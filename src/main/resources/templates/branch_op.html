<style>
#branch-entry-list {
	overflow-y: auto;
	max-width: 200px;
	min-width: 130px;
	float: right;
}

#branch-entry-list-header .list-group-item {
	
}

#branch-entry-list-header .list-group-item, #branch-entry-list .list-group-item
	{
	z-index: 2000;
}

#branch-entry-list-body .entry-title {
	font-size: 12px;
}

#branch-entry-list-body .entry-description {
	font-size: 14px;
	margin-bottom: 8px;
}

.reservationsOfOrder, .paysOfOrder {
	height: 200px;
	overflow-y: auto;
}

h5 {
	margin: 5px;
	padding-bottom: 5px;
}
</style>
<div class="container-fluid" id="branch-op-app">
	<!--
        <div class="row">
            <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                <h1 th:text="${title}"></h1>
            </div>
            <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 text-xs-right">
                <a th:href="@{'/branch/' + ${branch.branchId} + '/members'}" class="btn btn-primary">회원 관리</a>
                <a th:href="@{'/branch/' + ${branch.branchId} + '/design'}" class="btn btn-primary">열람실/좌석 관리</a>
        </div>
    </div>
    -->

	<div class="row">
		<div class="col-lg-10 col-md-9 col-sm-8 col-xs-6">
			<section class="branch-layout" id="branch-op-list"></section>
		</div>
		<div class="col-lg-2 col-md-3 col-sm-4 col-xs-6">
			<section id="branch-entry-list">
				<div id="branch-entry-list-header" class="list-group">
					<a href="#branch-entry-list-body"
						class="list-group-item list-group-item-action"
						data-toggle="collapse">출입기록</a>
				</div>
				<div id="branch-entry-list-body" class="list-group"></div>
			</section>
		</div>
	</div>

	<div class="modal fade modal-desk" id="modal-order-form" tabindex="1"
		role="dialog" aria-labelledby="" aria-hidden="true"
		style="z-index: 1050; overflow: auto;">
		<div class="modal-dialog modal-lg" role="document"
			style="max-width: 1530px">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title"></h4>
				</div>
				<div class="modal-body">
					<div class="container-fluid">
						<div class="memberSection">
							<div class="col-lg-5 col-md-4 col-xs-4">

								<h5>회원 정보</h5>
								<section class="member"></section>
								<button type="button"
									class="btn btn-sm btn-primary pull-xs-right"
									id="btn-form-updateMember" style="display: none;">회원정보
									수정</button>
							</div>
						</div>

						<div class="col-md-7 orderSection">
							<div>
								<div>
									<button type="button"
										class="btn btn-outline-primary pull-xs-right"
										id="btn-new-reservation">새 등록</button>
								</div>
								<h5>등록 현황</h5>
								<section>
									<div class="container-fluid">
										<!--                                     <div class="col-xs-6 col-md-6"> -->
										<div class="col-xs-12">
											<section class="deskReservationList"></section>
										</div>
									</div>
								</section>
							</div>
							<div class="col-xs-12 m-t-2"></div>

							<div class="orderForm" style="display: none;">
								<div class="row" style="border: 1px solid #ddd;">
									<div class="col-lg-7 col-md-12 m-b-1">
										<!--  <div class="col-xs-12 m-t-2">  -->
										<div class="pull-xs-right">
											<button type="button"
												class="btn btn-sm btn-outline-primary btn-form-add-reservation">등록
												추가</button>
										</div>
										<div class="pull-xs-right">
											<button type="button"
												class="btn btn-sm btn-outline-primary btn-form-history">히스토리 보기
											</button>
										</div>
										<!--
										<div class="pull-xs-right">
											<button type="button"
												class="btn btn-sm btn-outline-primary btn-form-clear">배석해제
											</button>
										</div>
										  -->
										
										<h5>등록내역</h5>
										<ul class="reservationsOfOrder list-group m-b-1"></ul>
										<!-- 	                                <button type="button" class="btn btn-danger" id="btn-delete-reservation">삭제</button> -->

										<!-- <div sec:authorize="hasAuthority('manager') or hasAuthority('user') " th:each="b,status: ${branches}" th:if="${#authorization.expression('hasAuthority(''' + b.branchId + ''')')}">  -->

										<div
											sec:authorize="hasAuthority('admin') or hasAuthority('manager') ">
											<button type="button" class="btn btn-sm btn-danger"
												id="btn-delete-reservation">전체 등록 삭제</button>
										</div>

										<div class="checkout" style="display: none;">
											<button type="button" class="btn btn-sm btn-primary"
												id="btn-checkout">퇴실 처리</button>
										</div>

										<div class="changeReservation" style="display: none;">
											<h5>등록 수정</h5>
											<div class="changeReservationForm"></div>
										</div>
										<!-- 
	                                <div class="addReservation" style="display: none;">	                                    
	                                    <h5>등록 추가</h5>
	                                    <div class="addReservationForm"></div>	                                    
	                                </div>
	                                -->
									</div>
									<div class="col-lg-5 col-md-12 m-b-2">
										<!-- <button type="button" class="btn btn-sm btn-outline-primary btn-form-add-pay pull-xs-right" id="btn-form-add-pay">결제 추가</button><h5>결제내역</h5> -->
										<ul class="paysOfOrder list-group m-b-1"></ul>
										<div class="addPay" style="display: none;">
											<h5>결제 추가</h5>
											<div class="addPayForm"></div>
										</div>
									</div>
								</div>
							</div>

							<!--<div class="col-lg-7 col-md-12 col-xs-12">
	                            <h5>결제내역</h5>
	                            <section class="deskPayList"></section>
	                        </div>
	                        <div class="col-lg-5 col-md-12 col-xs-12">
	                            <h5>출입내역</h5>
	                            <section class="deskEntryList"></section>
	                        </div>-->
							<div class=" col-xs-12 m-t-2"></div>
							<div class="newOrderSection">
								<h5>새 등록</h5>
								<section class="newOrder"></section>
								<div class="pull-xs-right">
									<button type="button" class="btn btn-sm btn-primary"
										id="btn-new-order">저장</button>
									<button type="button" class="btn btn-sm btn-secondary"
										id="btn-cancel-new-order">취소</button>
								</div>
							</div>


							<div class="addReservation" style="display: none;">
								<h5>등록 추가</h5>
								<div class="addReservationForm"></div>
							</div>


						</div>
					</div>
				</div>

				<div class="modal-footer">
					<div class="pull-xs-left">
						<!-- <button type="button" class="btn btn-outline-primary" id="btn-new-member">회원 추가</button>
                        <button type="button" class="btn btn-outline-primary" data-dismiss="modal" id="btn-new-reservation">등록 추가</button>
                        <button type="button" class="btn btn-outline-primary" data-dismiss="modal" id="btn-new-pay">결제 추가</button> -->
					</div>
					<button type="button" class="btn btn-secondary"
						data-dismiss="modal">닫기</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="modal-new-member-form" tabindex="-1"
		role="dialog" aria-labelledby="" aria-hidden="true"
		style="display: none; z-index: 1060; overflow: auto;">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title"></h4>
				</div>
				<div class="modal-body"></div>
				<div class="modal-footer">
					<div class="pull-xs-left"></div>
					<button type="button" class="btn btn-primary"
						id="btn-save-new-member">추가</button>
					<button type="button" class="btn btn-secondary"
						data-dismiss="modal">취소</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="modal-freeSeat-form" tabindex="2"
		role="dialog" aria-labelledby="" aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content" style="width: 1100px;">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title"></h4>
				</div>
				<div class="modal-body">
					<section class="row">
						<table class="table">
							<thead>
								<tr>
									<th class="p-l-3">일시</th>
									<th class="text-xs-center">회원</th>
									<th>열람실 / 좌석</th>
									<th>인원</th>
									<th class="p-l-3">등록기간</th>
									<th>등록상태</th>
									<th class="p-l-3">메모</th>
									<th class="p-l-2">수정</th>
								</tr>
							</thead>
							<tbody id="freeSeat-list"></tbody>
							<tr>
								<th></th>
								<th></th>
								<th></th>
								<th></th>
								<th></th>
								<th></th>
								<th></th>
								<th></th>
							</tr>
						</table>
					</section>
				</div>
				<div class="modal-footer">
					<div class="pull-xs-left">
						<button type="button" class="btn btn-secondary"
							data-dismiss="modal">취소</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="modal-list-form" tabindex="2" role="dialog"
		aria-labelledby="" aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content" style="width: 1100px;">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title"></h4>
				</div>
				<div class="modal-body">
					<section class="row">
						<table class="table">
							<thead>
								<tr>
									<th class="p-l-3">일시</th>
									<th class="text-xs-center">회원</th>
									<th>열람실 / 좌석</th>
									<th>인원</th>
									<th class="p-l-3">등록기간</th>
									<th>등록상태</th>
									<th class="p-l-3">메모</th>
									<th class="p-l-2">수정</th>
								</tr>
							</thead>
							<tbody id="toBeReservation-list"></tbody>
							<tbody id="reserved-list"></tbody>
							<tbody id="out-list"></tbody>
							<tbody id="in-list"></tbody>
							<tbody id="outing-list"></tbody>
							<tbody id="below-7-list"></tbody>
							<tbody id="below-4-list"></tbody>
							<tbody id="below-1-list"></tbody>
							<tbody id="receivable-list"></tbody>
							<tr>
								<th></th>
								<th></th>
								<th></th>
								<th></th>
								<th></th>
								<th></th>
								<th></th>
								<th></th>
							</tr>

						</table>
					</section>
				</div>
				<div class="modal-footer">
					<div class="pull-xs-left">
						<button type="button" class="btn btn-secondary"
							data-dismiss="modal">취소</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<button type="button" class="btn btn-outline-primary"
		id="btn-form-freeSeat">자유석 리스트</button>
	<!-- <button type="button" class="btn btn-outline-primary" id="btn-form-toBeReservation">예약회원 리스트</button>  -->
</div>

<script th:include="tmpl_form_member" th:inline="javascript"
	type="text/template" id="member-form-template"></script>

<script th:include="tmpl_form_new_order_add" th:inline="javascript"
	type="text/template" id="new-order-form-template"></script>
<script th:include="tmpl_form_new_order" th:inline="javascript"
	type="text/template" id="order-form-template"></script>
<script th:include="tmpl_tr_reservation_of_order" th:inline="javascript"
	type="text/template" id="reservation-of-order-template"></script>
<script th:include="tmpl_tr_pay_of_order" th:inline="javascript"
	type="text/template" id="pay-of-order-template"></script>
<script th:include="tmpl_tr_reservation" th:inline="javascript"
	type="text/template" id="freeSeat-template"></script>
<script th:include="tmpl_tr_toBeReservation" th:inline="javascript"
	type="text/template" id="stateList-template"></script>



<script th:inline="javascript" type="text/template" id="room-template">
    <div class="names"><span class="">{{- name }}</span></div>
</script>

<script th:inline="javascript" type="text/template" id="desk-template">
	<![CDATA[ -->
    <div class="names"><span>{{- name}}</span> <span class="reservationNum pull-xs-right"></span></div>
    <div class="reservations"></div>
    
<!-- ]]> --></script>


<script th:inline="javascript" type="text/template"
	id="desk-reservation-template">
	<![CDATA[ -->
    <div class="status-bar"></div>
    <div class="title"> {{- member.name }}</div>
    <div class="subtitle">{{- moment(deskEndDt).format("MM/DD")  }} (<span id="diff"  style="color:white;">{{- diff }}</span>)</div>
<!-- ]]> --></script>

<script th:inline="javascript" type="text/template"
	id="desk-reservation-template2">
	<![CDATA[ -->
    <div class="status-bar"></div>
    <div class="title"> {{- member.name }}</div>
    <div class="subtitle">{{- moment(deskEndDt).format("MM/DD")  }} (<span id="diff"  style="color:yellow;font-weight:bold;">{{- diff }}</span>)</div>
<!-- ]]> --></script>

<script th:inline="javascript" type="text/template" id="member-template">
    <span>{{- name }}</span>
</script>

<script th:inline="javascript" type="text/template" id="pay-template">
	<![CDATA[ -->
    <span><span class="tag tag-primary">{{- member.no }}</span> {{- member.name }}</span> <button type="button" class="btn btn-sm btn-outline-secondary btn-view-pay">상세보기</button><br/></span>
<!-- ]]> --></script>
<script th:inline="javascript" type="text/template"
	id="reservation-template">
	<![CDATA[ -->
    <span>
    	<span class="tag tag-primary">{{- member.no }}</span> {{- member.name }}
    	{{ if(reservationNum > 1) { }}
	    	외 {{- reservationNum-1}} 명 
	    {{ } }}
    </span>
    
    <span>{{- moment(deskStartDt).format('LL') }} {{- deskStartTm.substring(0, 5)}} 부터 {{- moment(deskEndDt).format('LL') }} {{- deskEndTm.substring(0, 5)}} 까지</span> <span>[{{- moment(deskEndDt).diff(moment(), 'days') + 1 }}일 후 만기]</span>
    <button type="button" class="btn btn-sm btn-outline-secondary btn-view-reservation">상세</button>
    <button type="button" class="btn btn-sm btn-outline-primary btn-form-change-reservation ">수정</button>
    
<!-- ]]> --></script>

<script th:inline="javascript" type="text/template"
	id="reservation-template-time">
	<![CDATA[ -->
   	<label {{ if(flag == -1) { }} class="error" {{ } }}>
   	<span>
   		<span class="tag tag-primary">{{- member.no }}</span> 
   			{{- member.name }}
   			{{ if(reservationNum > 1) { }}
	    		외 {{- reservationNum-1}} 명 
	    	{{ } }}
   		</span>
   	{{ if(deskStartDt == deskEndDt) { }}
   	<span>{{- moment(deskStartDt).format('LL') }} {{- deskStartTm.substring(0, 5)}} 부터 {{- deskEndTm.substring(0, 5)}} 까지</span>
   	{{ } }}
   	{{ if(deskStartDt != deskEndDt) { }}
   	<span>{{- moment(deskStartDt).format('LL') }} {{- deskStartTm.substring(0, 5)}} 부터 {{- moment(deskEndDt).format('LL') }} {{- deskEndTm.substring(0, 5)}} 까지</span>
   	{{ } }}
   	<span>[{{- deskTime }} ]</span>
   	</label>
    <button type="button" class="btn btn-sm btn-outline-secondary btn-view-reservation">상세</button>
    <button type="button" class="btn btn-sm btn-outline-primary btn-form-change-reservation">수정</button>
  
<!-- ]]> --></script>

<script th:inline="javascript" type="text/template" id="entry-template">
	<![CDATA[ -->
    <div class="entry-title">{{- moment(entryDt).format('HH:mm') }} 
    	{{ if(entryType == 1) { }}
    		입실
   		{{ } else if(entryType == 2) { }}
   			퇴실
		{{ } else if(entryType == 3) { }}
			외출
		{{ } else if(entryType == 4) { }}
			복귀
		{{ } }}
	</div>
    <div class="entry-description">
        <span class="tag tag-primary">{{- member.no }}</span> {{- member.name }}
    </div>
<!-- ]]> --></script>

<script th:inline="javascript" type="text/template" id="stats-template">
	<![CDATA[ -->
    <div class="reservations">
        <div class="stats reservation" >
            <div class="status-bar"></div>
            <div class="title">전체좌석</div>
            <div class="subtitle">{{- countOfReserved+countOfOut+countOfIn+countOfOuting }} / {{- countOfTotal }}</div>
        </div>

        <div class="stats reservation" data-status="reserved" id="reserved">
            <div class="status-bar"></div>
            <div class="title">미방문</div>
            <div class="subtitle">{{- countOfReserved }}</div>
        </div>

        <div class="stats reservation" data-status="to-be-reserved" id="toBeReserved">
            <div class="status-bar"></div>
            <div class="title">예약</div>
            <div class="subtitle">{{- countOfTobereserved }}</div>
        </div>

        <div class="stats reservation" data-status="out" id="out">
            <div class="status-bar"></div>
            <div class="title">학습후 퇴실</div>
            <div class="subtitle">{{- countOfOut }}</div>
        </div>

        <div class="stats reservation" data-status="in" id="in">
            <div class="status-bar"></div>
            <div class="title">학습중</div>
            <div class="subtitle">{{- countOfIn }}</div>
        </div>

        <div class="stats reservation" data-status="outing" id="outing">
            <div class="status-bar"></div>
            <div class="title">휴식</div>
            <div class="subtitle">{{- countOfOuting }}</div>
        </div>

        <div class="stats reservation" data-status="time" data-remain-status="below-7" id="below-7">
            <div class="status-bar"></div>
            <div class="title">잔여 7일</div>
            <div class="subtitle">{{- countOfBelow7 }}</div>
        </div>

        <div class="stats reservation" data-status="time" data-remain-status="below-4" id="below-4">
            <div class="status-bar"></div>
            <div class="title">잔여 4일</div>
            <div class="subtitle">{{- countOfBelow4 }}</div>
        </div>

        <div class="stats reservation" data-status="time" data-remain-status="below-1" id="below-1">
            <div class="status-bar"></div>
            <div class="title">잔여 1일</div>
            <div class="subtitle">{{- countOfBelow1 }}</div>
        </div>

		<div class="stats reservation" pay-status="receivable" id="receivable">
            <div class="status-bar"></div>
            <div class="title">미수금</div>
            <div class="subtitle">{{- countOfReceivable }}</div>
        </div>        
                       
    </div>
<!-- ]]> --></script>

<script th:inline="javascript" type="text/template"
	id="membership-card-template">
	<![CDATA[ -->
    <div class="input-group">
        <span class="input-group-btn">
            <button class="btn btn-secondary" type="button"><i class="fa fa-barcode" aria-hidden="true"></i></button>
        </span>
        <input type="text" name="membership" id="membership" class="form-control" placeholder="멤버십번호, 회원번호"/>
        <span class="input-group-btn">
            <button class="btn btn-secondary" type="button" id="btn-search-membership">찾기</button>
        </span>
    </div>
<!-- ]]> --></script>



<script th:inline="javascript" type="text/template"
	id="reservation-form-template">
	<![CDATA[ -->
    <form id="reservationFormTemplate">
        <input type="hidden" name="orderId" value="{{- orderId}}" />
        <input type="hidden" name="reservationDt" value="{{- reservationDt}}" />
        <input type="hidden" name="reservationTm" value="{{- reservationTm}}" />
        <input type="hidden" name="reservationStatus" value="{{- reservationStatus}}" />
        <div class="container-fluid">
            <div class="col-md-12">
                <div class="form-group">
                    <label class="form-control-label">회원</label>
                    <select class="chosen" name="memberId" id="memberId">
                        <option value="">미입력</option>
                        {{ _.each(members, function(member){ }}<option value="{{- member.memberId }}" {{ if(memberId == member.memberId) { }}selected="selected"{{ } }}>{{- member.no }} {{- member.name }}</option>{{ }); }}
                    </select>
                </div>
                <div class="form-group">
            	<label class="form-control-label" >인원</label>	
					<div class="input-group">
						<input type="number" class="form-control text-xs-right" name="reservationNum" value="{{- reservationNum }}" min="1" step="1" />
						<div class="input-group-addon">명</div>
					</div>
           		</div>
                <div class="form-group">
                    <label class="form-control-label">열람실 / 좌석</label>
                    <select class="chosen" name="deskId" id="deskId">
                        <option value="">지정안함</option>
                        {{ _.each(desks, function(desk){ }}<option value="{{- desk.deskId }}" {{ if(deskId == desk.deskId) { }}selected="selected"{{ } }}>{{- _.find(rooms, function(room){ return (room.roomId == desk.roomId) }).name }} / {{- desk.name }}</option>{{ }); }}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-control-label">등록기간</label>
                    &nbsp&nbsp<label class="form-control-label" id="dateCount">총 1일</label>&nbsp&nbsp
                        <button type="button" class="btn btn-sm btn-secondary btn-set-time" data-add-value="3" data-add-unit="h">3시간</button>
                        <button type="button" class="btn btn-sm btn-secondary btn-set-time" data-add-value="6" data-add-unit="h">6시간</button>
                        <button type="button" class="btn btn-sm btn-secondary btn-set-time" data-add-value="1" data-add-unit="d" id="1day">1일</button>
                        <button type="button" class="btn btn-sm btn-secondary btn-set-time" data-add-value="2" data-add-unit="PM">1달</button>
						<button type="button" class="btn btn-sm btn-secondary btn-set-time" data-add-value="1" data-add-unit="PM">+1일</button>
						<button type="button" class="btn btn-sm btn-secondary btn-set-time" data-add-value="-1" data-add-unit="PM">-1일</button>
						                                            
                    <input type="hidden" name="deskStartDt" value="{{- deskStartDt }}" />
                    <input type="hidden" name="deskEndDt" value="{{- deskEndDt }}" />
                    <div class="input-group input-daterange">
                        <input type="text" class="form-control" id="deskStartDt" data-org-input-name="deskStartDt" value="{{- momentDateFormat(deskStartDt) }}" readonly="readonly" />
                        <div class="input-group-addon">부터</div>
                        <input type="text" class="form-control" id="deskEndDt" data-org-input-name="deskEndDt" value="{{- momentDateFormat(deskEndDt) }}" readonly="readonly" />
                        <div class="input-group-addon">까지</div>
                    </div>
                    <input type="hidden" name="deskStartTm" value="{{- deskStartTm }}" />
                    <input type="hidden" name="deskEndTm" value="{{- deskEndTm }}" />
                    <div class="input-group clockpicker-with-callbacks input-timerange">
				    <input class="form-control" time-org-input-name="deskStartTm" id="deskStartTm"  value="{{- momentTimeFormat(deskStartTm) }}" placeholder="Now">
				    <span class="input-group-addon">
				        <span class="fa fa-clock-o"></span>
				    </span>
				    <input class="form-control" time-org-input-name="deskEndTm" id="deskEndTm" value="{{- momentTimeFormat(deskEndTm) }}" placeholder="Now">
				    <span class="input-group-addon">
				        <span class="fa fa-clock-o"></span>
				    </span>

				</div>
                    
                </div>
                <div class="form-group">
                    <label class="form-control-label">등록메모</label>
                    <textarea class="form-control" name="reservationNote">{{- reservationNote }}</textarea>
                </div>
                <div class="pull-xs-right">
                    <button type="button" class="btn btn-sm btn-primary btn-save-reservation">저장</button>
                    <button type="button" class="btn btn-sm btn-secondary btn-do-not-save-reservation">취소</button>
                </div>
            </div>
        </div>
        
    </form>    
<!-- ]]> --></script>

<script th:inline="javascript" type="text/template"
	id="addReservation-form-template">
	<![CDATA[ -->
    <form id="reservationFormTemplate">
        <input type="hidden" name="orderId" value="{{- orderId}}" />
        <input type="hidden" name="reservationDt" value="{{- reservationDt}}" />
        <input type="hidden" name="reservationTm" value="{{- reservationTm}}" />
        <input type="hidden" name="reservationStatus" value="{{- reservationStatus}}" />
        <div class="container-fluid">
            <div class="col-lg-7 col-md-12 col-xs-12">
                <div class="form-group">
                    <label class="form-control-label">회원</label>
                    <div class="col-xs-12">
	                    <select class="chosen" name="memberId" id="memberId">
	                        <option value="{{- memberId}}"> {{- no}} {{- memberName}}</option>
	                       <!-- {{ _.each(members, function(member){ }}<option value="{{- member.memberId }}" {{ if(memberId == member.memberId) { }}selected="selected"{{ } }}>{{- member.no }} {{- member.name }}</option>{{ }); }}-->
	                    </select>
	                </div>
                </div>
                <div class="form-group">
            	<label class="form-control-label" >인원</label>	
					<div class="input-group">
						<input type="number" class="form-control text-xs-right" name="reservationNum" value="{{- reservationNum }}" min="1" step="1" />
						<div class="input-group-addon">명</div>
					</div>
           		</div>
                <div class="form-group">
                    <label class="form-control-label">열람실 / 좌석</label>
                    <select class="chosen" name="deskId" id="deskId">
                        <option value="">지정안함</option>
                        {{ _.each(desks, function(desk){ }}<option value="{{- desk.deskId }}" {{ if(deskId == desk.deskId) { }}selected="selected"{{ } }}>{{- _.find(rooms, function(room){ return (room.roomId == desk.roomId) }).name }} / {{- desk.name }}</option>{{ }); }}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-control-label">등록기간</label>
                    	&nbsp&nbsp<label class="form-control-label" id="dateCount">총 1일</label>&nbsp&nbsp
                        <button type="button" class="btn btn-sm btn-secondary btn-set-time" data-add-value="3" data-add-unit="h">3시간</button>
                        <button type="button" class="btn btn-sm btn-secondary btn-set-time" data-add-value="6" data-add-unit="h">6시간</button>
                        <button type="button" class="btn btn-sm btn-secondary btn-set-time" data-add-value="1" data-add-unit="d" id="1day">1일</button>
                        <button type="button" class="btn btn-sm btn-secondary btn-set-time" data-add-value="2" data-add-unit="PM">1달</button>
						<button type="button" class="btn btn-sm btn-secondary btn-set-time" data-add-value="1" data-add-unit="PM">+1일</button>
						<button type="button" class="btn btn-sm btn-secondary btn-set-time" data-add-value="-1" data-add-unit="PM">-1일</button>
                    <input type="hidden" name="deskStartDt" value="{{- deskStartDt }}" />
                    <input type="hidden" name="deskEndDt" value="{{- deskEndDt }}" />
                    <div class="input-group input-daterange">
                        <input type="text" class="form-control" id="deskStartDt" data-org-input-name="deskStartDt" value="{{- momentDateFormat(deskStartDt) }}" readonly="readonly" />
                        <div class="input-group-addon">부터</div>
                        <input type="text" class="form-control" id="deskEndDt" data-org-input-name="deskEndDt" value="{{- momentDateFormat(deskEndDt) }}" readonly="readonly" />
                        <div class="input-group-addon">까지</div>
                    </div>
                    <input type="hidden" name="deskStartTm" value="{{- deskStartTm }}" />
                    <input type="hidden" name="deskEndTm" value="{{- deskEndTm }}" />
                    <div class="input-group clockpicker-with-callbacks input-timerange">
				    <input class="form-control" time-org-input-name="deskStartTm" id="deskStartTm"  value="{{- momentTimeFormat(deskStartTm) }}" placeholder="Now">
				    <span class="input-group-addon">
				        <span class="fa fa-clock-o"></span>
				    </span>
				    <input class="form-control" time-org-input-name="deskEndTm" id="deskEndTm" value="{{- momentTimeFormat(deskEndTm) }}" placeholder="Now">
				    <span class="input-group-addon">
				        <span class="fa fa-clock-o"></span>
				    </span>

				</div>
                    
                </div>
                <div class="form-group">
                    <label class="form-control-label">등록메모</label>
                    <textarea class="form-control" name="reservationNote">{{- reservationNote }}</textarea>
                </div>
                <div class="pull-xs-right">
                    <button type="button" class="btn btn-sm btn-primary btn-save-reservation">저장</button>
                    <button type="button" class="btn btn-sm btn-secondary btn-do-not-save-reservation">취소</button>
                </div>
            </div>
            <div class="col-lg-5 col-md-12 col-xs-12">
	            <div class="form-group">
	                <label class="form-control-label">결제구분</label>
						<div class="form-group">
							<label class="form-check-inline">
								<input class="form-check-input" style="display: none;" type="radio" name="payType" value="no" {{ if((payType != 1) && (payType != 2) && (payType != 3)){ }}checked="checked"{{ } }} />
							</label>
							<label class="form-check-inline">
		                        <input class="form-check-input" type="radio" name="payType" value="1" {{ if(payType == 1){ }}checked="checked"{{ } }} />현금 
		                    </label>
		                    <label class="form-check-inline">
	                        	<input class="form-check-input" type="radio" name="payType" value="5" {{ if(payType == 5){ }}checked="checked"{{ } }} />계좌이체 
	                    	</label>
							<label class="form-check-inline">
		                        <input class="form-check-input" type="radio" name="payType" value="2" {{ if(payType == 2){ }}checked="checked"{{ } }} />신용카드 
		                    </label>
							<label class="form-check-inline">
		                        <input class="form-check-input" type="radio" name="payType" value="3" {{ if(payType == 3){ }}checked="checked"{{ } }} />미수금 
		                    </label>		                    
							<label class="form-check-inline">
		                        <input class="form-check-input" type="radio" name="payType" value="no" {{ if((payType != 1) && (payType != 2) && (payType != 3) && (payType != 5) ){ }}checked="checked"{{ } }} />미입력 
		                    </label>	                    					
						</div>
	            </div>
	            <div class="form-group">
	                <label class="form-control-label">결제금액</label>
	                <div class="input-group">
						<input id="payAmount" type="text" class="form-control text-xs-right" name="payAmount" value="{{- payAmount }}" />
	                    <div class="input-group-addon">원</div>
	                </div>
	            </div>
	            <div class="form-group">
	                <label class="form-control-label">결제메모</label>
	                <textarea class="form-control" name="payNote"></textarea>
	            </div>
        </div>   
	</div>
<!-- ]]> --></script>



<script th:inline="javascript" type="text/template"
	id="pay-form-template">
	<![CDATA[ -->
    <form>
    <input type="hidden" name="orderId" value="{{- orderId}}" />
	<input type="hidden" name="reservationId" value="{{- reservationId}}" />
        <div class="container-fluid">
            <div class="col-lg-6 col-md-12 col-xs-12">
                <!--<div class="form-group">
                    <label class="form-control-label">결제일자</label>                    
                    <input type="hidden" name="payDt" value="{{- payDt }}" />
                    <div class="input-group">
                        <span class="input-group-btn">
                            <button class="btn btn-secondary" type="button"><i class="fa fa-calendar" aria-hidden="true"></i></button>
                        </span>
                        <input type="text" class="form-control datepicker" data-org-input-name="payDt" value="{{- momentDateFormat(payDt) }}" readonly="readonly" />
                    </div>
                </div>-->
                <div class="form-group">
                <label class="form-control-label">결제구분</label>
					<div class="form-group">
						<label class="form-check-inline">
							<input class="form-check-input" style="display: none;" type="radio" name="payType" value="no" {{ if((payType != 1) && (payType != 2) && (payType != 3)){ }}checked="checked"{{ } }} />
						</label>
						<label class="form-check-inline">
	                        <input class="form-check-input" type="radio" name="payType" value="1" {{ if(payType == 1){ }}checked="checked"{{ } }} />현금 
	                    </label>
	                    <label class="form-check-inline">
	                        <input class="form-check-input" type="radio" name="payType" value="5" {{ if(payType == 5){ }}checked="checked"{{ } }} />계좌이체 
	                    </label>
						<label class="form-check-inline">
	                        <input class="form-check-input" type="radio" name="payType" value="2" {{ if(payType == 2){ }}checked="checked"{{ } }} />신용카드 
	                    </label>
						<label class="form-check-inline">
	                        <input class="form-check-input" type="radio" name="payType" value="3" {{ if(payType == 3){ }}checked="checked"{{ } }} />미수금 
	                    </label>	                    
						<label class="form-check-inline">
	                        <input class="form-check-input" type="radio" name="payType" value="no" {{ if((payType != 1) && (payType != 2) && (payType != 3) && (payType != 5) ){ }}checked="checked"{{ } }} />미입력 
	                    </label>	                    					
					</div>
            	</div>
                <div class="form-group">
                    <label class="form-control-label">결제금액</label>
                    <div class="input-group">
                        <input id="payAmount" type="text" class="form-control text-xs-right" name="payAmount" value="{{- payAmount }}" />
                        <div class="input-group-addon">원</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 col-md-12 col-xs-12">
                <div class="form-group">
                    <label class="form-control-label">회원</label>
                    <select class="chosen" name="memberId" id="memberId">
                        <option value="">미입력</option>
                        {{ _.each(members, function(member){ }}<option value="{{- member.memberId }}" {{ if(memberId == member.memberId) { }}selected="selected"{{ } }}>{{- member.name }}</option>{{ }); }}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-control-label">결제메모</label>
                    <textarea class="form-control" name="payNote">{{- payNote }}</textarea>
                </div>
            </div>
            <div class="pull-xs-right">
				<button type="button" class="btn btn-sm btn-danger btn-refund" id="btn-refund">환불</button>
                <button type="button" class="btn btn-sm btn-primary btn-add-pay" id="btn-add-pay">저장</button>
                <button type="button" class="btn btn-sm btn-secondary btn-do-not-add-pay">취소</button>
            </div>
        </div>
    </form>
<!-- ]]> --></script>

<script th:inline="javascript" type="text/template"
	id="freeSeat-form-template">
	<![CDATA[ -->
	<form>
		<div class="container-fluid">
            <div class="col-lg-6 col-md-12 col-xs-12">
        
            </div>        
        </div>
	</form>
<!-- ]]> --></script>


<script src="https://ssl.daumcdn.net/dmaps/map_js_init/postcode.v2.js"></script>
<script th:inline="javascript">// <![CDATA[
$("#memberId").change(function (e) {
	alert("this is an alert2"); 
});
//알림톡 정보
 var roomName = null;
 var deskName = null;
 var memberName = null;
 var phone_number = null;
 var school = null;
 var registration = null;
 var amount = null;
 var tempAmount = null;
 var validatorMember = null;
 var validatorOrder = null;
 //var memberRegFlag = false;
 var memberFormFlag = false; //멤버 등록창에서 바로 등록 했을 경우 flag
 var memberOrderFlag = false;
 var valuesMember = {};
 var validatorMember;
 
 //알림톡 전송
 function alimtalkSend(Alimtalk) {
		jQuery.ajax({
	        method : "POST",
	        url : "/api/v1/branch/" + [[${branch.branchId}]] + "/alimTalk",
	        contentType: "application/json; charset=UTF-8",
	        data : JSON.stringify(Alimtalk),
	        dataType : "JSON" ,
	        success : function() {
	           //alert("Suceeded!");         
	        },
	        error : function() {
	           //alert("Failed!");
	        }
	    });

	}
 
// 새 등록 추가                                           
function SaveNewOrder(values, OrderList, ReservationList, PayList) {
	var $modal = $('#modal-order-form');
	if (values['memberId'] == "") {
    	alert("memberId null!");
    }
    else {
    OrderList.create({
        memberId: values['memberId'],
        orderNote: values['orderNote'],

    }, {
        wait : true,
        success : function (model, response) {
            
        	var orderId = response.orderId;
            model.set('orderId', orderId);
            model.set('orderStatus', response.orderStatus);
            model.set('insertDt', response.insertDt);
            model.set('updateDt', response.updateDt);

			var startTimeStamp = values['deskStartDt'];
            
			startTimeStamp = parseInt(startTimeStamp);
            //var timestamp=new Date('02/10/2016').getTime();
            var todate=new Date(startTimeStamp).getDate();
            var tomonth=new Date(startTimeStamp).getMonth()+1;
            var toyear=new Date(startTimeStamp).getFullYear();
            var original_date=tomonth+'/'+todate+'/'+toyear;
            var timestamp_formation = new Date(original_date).getTime();
            var IntStartTimeStamp = timestamp_formation.toString().substring(0,10);
            IntStartTimeStamp  = parseInt(IntStartTimeStamp)+ 32400;
           
            console.log(IntStartTimeStamp);
            
            
            var timeStamp = values['deskEndDt'];
            
            timeStamp = parseInt(timeStamp);
            //var timestamp=new Date('02/10/2016').getTime();
            var todate=new Date(timeStamp).getDate();
            var tomonth=new Date(timeStamp).getMonth()+1;
            var toyear=new Date(timeStamp).getFullYear();
            var original_date=tomonth+'/'+todate+'/'+toyear;
            var timestamp_formation = new Date(original_date).getTime();
            var IntTimeStamp = timestamp_formation.toString().substring(0,10);
            IntTimeStamp  = parseInt(IntTimeStamp)+ 32400 + 86400-1;
           console.log(IntTimeStamp);
           console.log(values['no']); 
           
            ReservationList.create({
                orderId: orderId,
                deskId: values['deskId'],
                reservationNum: values['reservationNum'],
                deskStartDt: values['deskStartDt'],
                deskStartTm: values['deskStartTm'],
                deskEndDt: values['deskEndDt'],
                deskEndTm: values['deskEndTm'],
                deskStartDtTimeStamp: IntStartTimeStamp,
                deskEndDtTimeStamp: IntTimeStamp,
                memberNo :values['no'],
                memberId: values['memberId'],
                reservationNote : values['reservationNote']

            }, {
                wait : true,
                success : function (model, response) {
                	var reservationId = response.reservationId;
                	
                    PayList.create({
                        orderId: orderId,
                        reservationId: reservationId,
                        payDt: sysDate.clone().valueOf(),
                        payType: values['payType'],
                        payInOutType: values['payInOutType'],
                        payAmount: values['payAmount'],
                        payNote: values['payNote'],
                        memberId: values['memberId'],

                    }, {
                        wait : true,
                        success : function (model, response) {
                        	if (values['payAmount'] > 0) {
                				/*
                        		if (phone_number != '' || phone_number != null) {                					
                					//고객에게 알림톡 전송
                					var Alimtalk = {
                    						roomName: roomName,
                    						deskName: deskName,
                        					memberName: memberName,
                        					phone_number: phone_number,
                        					school: school,
                        					registration: registration,
                        					amount: amount
                        			};			            			         
                					alimtalkSend(Alimtalk);
                				}
                				*/
			                  	//센터장에게 알림톡 전송
			                    var AlimtalkManager = {
                						roomName: roomName,
                						deskName: deskName,
                    					memberName: memberName,
                    					phone_number: [[${branch.telEtc}]],
                    					school: school,
                    					registration: registration,
                    					amount: amount
                    			};
                				console.log('Alimtalk');
                				console.log(AlimtalkManager);
			                    alimtalkSend(AlimtalkManager);
            				}
                        	
                          $modal.modal('hide');
                          location.reload();
                        }

                    });

                }

            });


        }

    });
    }	
}                                           


var reservationStatusTypeMap = JSON.parse([[${reservationStatusTypeMapJSON}]]);      
var payTypeMap = JSON.parse([[${payTypeMapJSON}]]);
var flag = 'branch_op';
var testmodel;
var branchType = [[${branch.branchType}]];
var branchId = [[${branch.branchId}]];
var branchTel = [[${branch.telEtc}]];
var examTypes = [[${examTypes}]];
var jobTypes = [[${jobTypes}]];
var interestTypes = [[${interestTypes}]];
var schoolGrades = [[${schoolGrades}]];
var monthFlag = 0;
var reservationTrue = false;



$(function(){

	$('#memberId').find('.chosen').change( function(e) {		 	 
		alert('test1');		 
	 });
	
	 $('#memberId_chosen').find('.chosen').change( function(e) {		 	 
			alert('test2');		 
		 });
	$('select').chosen().change(function(event, data) {
		   alert('alert3');
		}); 
		
	$("#memberId_chosen").change(function (e) {
				alert("this is an alert1"); 
			});
	$("#memberId").change(function (e) {
				alert("this is an alert2"); 
			});
	

	$("#memberId_chosen").chosen('change', function(e) {
		alert('test1');
	});
	
	$("#memberId").chosen('change', function(e) {
		alert('test1');
	});
	
	$('.active-result').click(function(e) {
		alert('test1');
	});
		
	 
	// Member
	 var MemberList = new MemberListCollection();
	 MemberList.branchId = [[${branch.branchId}]];	

    $(window).on('resize', function(e) { resizeContent('#branch-entry-list'); });
    resizeContent('#branch-entry-list');

    // Reservation
    var ReservationList = new ReservationListCollection;
    ReservationList.branchId = [[${branch.branchId}]];

    // ReservationAll
    var ReservationAllList = new ReservationListCollection;
    ReservationAllList.branchId = [[${branch.branchId}]];
    
    // Room
    var RoomList = new RoomListCollection;
    RoomList.branchId = [[${branch.branchId}]];
    
    // Pay
    var PayList = new PayListCollection;
    PayList.branchId = [[${branch.branchId}]];
    
    var RoomView = Backbone.View.extend({
        tagName: 'div',
        className: 'box room',
        template: _.template($('#room-template').html()),
        events: {
        },
        initialize: function() {
            this.listenTo(this.model, 'change', this.change);
            this.listenTo(this.model, 'destroy', this.remove);

        },
        change: function(e) {
            var keys = _.keys(this.model.changedAttributes());
            if (_.difference(keys, ['w', 'h']).length == 0){
                // resizestop

            } else if (_.difference(keys, ['t', 'l']).length == 0){
                // dragstop

            } else {
                this.render();

            }

        },
        render: function() {
            var data = this.model.toJSON();
            this.el.id = data.roomId;

            this.$el.html(this.template(data));

            this.$el
            .css({
                top: data.t, left: data.l, height: data.h, width: data.w, position: 'absolute',
            });

            return this;

        },

    });

    // Desk

    var DeskList = new DeskListCollection;
    DeskList.branchId = [[${branch.branchId}]];
    DeskList.currentDeskModel = null;
    //DeskList.reset(JSON.parse([[${deskListJSON}]]));

    var DeskView = Backbone.View.extend({
        tagName: 'div',
        className: 'box desk',
        template: _.template($('#desk-template').html()),
        templateForNewOrderForm: _.template($('#new-order-form-template').html()),
        templateForMemberForm: _.template($('#member-form-template').html()),
        events: {
            'click': 'formDesk',
            //'click': 'formReservation',
        },
        initialize: function() {
            this.listenTo(this.model, 'change', this.change);
            this.listenTo(this.model, 'destroy', this.remove);
        },
        formDesk: function(model) {
        	monthFlag = 0;
        	var appMemberFlag = false;        
        	
        	var room = RoomList.get(this.model.get('roomId'));
            var title = room.get('name') + ' - ' + this.model.get('name');
            
            var currentDate = sysDate.clone();
            
            var deskId = this.model.get('deskId');

            var reservations = ReservationList.filter({ deskId: deskId });
            var reservationsAll = ReservationAllList.filter({ deskId: deskId });
            
            
            //등록이 존재할 경우
            if(reservations.length > 0) {
            	$('#btn-form-updateMember').show();
            	var reservationTrue = true;            	
            	
            	if ( branchType == 20 ) { //카페일 경우 일일 회원 퇴실처리를 한 데이터는 출력x	            	
	            	var member = MemberList.filter({ memberId: reservations[0].attributes.memberId });
	            	if (member[0].attributes.membershipNo != null && member[0].attributes.membershipNo.length >= 12) {
	            		if (reservations[0].attributes.checkoutYn == 0) {
	            			
	            			var $modal = $('.modal-desk');
	    	            	$modal.find('.orderForm').show();
	    	            	$modal.find('.checkout').show();
	    	            	$modal.find('.newOrderSection').hide();
	    	            				
	    	            	ReservationList.trigger('formReservation', reservations[0], ReservationList, MemberList, DeskList, RoomList, PayList, payTypes, flag, branchType, branchId, branchTel);
	    	            	//ReservationAllList.trigger('formReservation', reservations[0], ReservationList, MemberList, DeskList, RoomList, PayList, payTypes, flag, branchType, branchId, branchTel);
	    	            	
	    	            	var data = this.model.toJSON();	    	            	            	

	    	            	
	    	            	data['members'] = [[${members}]];
	    	                data['memberId'] = this.model.get("memberId");
	    	                data['desks'] = DeskList.toJSON();
	    	                data['rooms'] = RoomList.toJSON();
	    	                data['payAmount'] = 0;
	    	                data['payType'] = this.model.get("payType");
	    	                data['payTypes'] = payTypes;
	    	                data['pay'] = new PayModel().toJSON();
	    	                data['deskStartDt'] = currentDate.valueOf();
	    	                data['deskStartTm'] = currentDate.format('HH:mm:ss'); // '00:00:00';
	    	                data['deskEndDt'] = currentDate.valueOf();
	    	                data['deskEndTm'] = '23:59:59';
	    					data['examTypes'] = examTypes;
	    					data['jobTypes'] = jobTypes;
	    					data['interestTypes'] = interestTypes;
	    					data['schoolGrades'] = schoolGrades;
	    	                	
	    	                DeskList.currentDeskModel = this.model;
	    	                
	    	                var memberId = reservations[0].get('memberId');
	    	                var memberData = MemberList.get(memberId).toJSON();
	    	                memberData['examTypes'] = examTypes;
	    	                memberData['jobTypes'] = jobTypes;
	    	                memberData['interestTypes'] = interestTypes;
	    	                memberData['schoolGrades'] = schoolGrades;
	    	                if (memberData.no.indexOf("C") != -1) {
	    	                	appMemberFlag = true;
	    	                }
	    	                memberData['appMemberFlag'] = appMemberFlag;
	    	                
	    	    			if (memberData['email'] == null || memberData['email'] == '') {
	    	    				memberData['emailText'] = '';
	    	    				memberData['emailAdd'] = '';
	    	    			}
	    	    			else {
	    	    				var telStr = memberData['email'].split('@');
	    	    				memberData['emailText'] = telStr[0];
	    	    				memberData['emailAdd'] = telStr[1];
	    	    			}
	    	            	var memberHtml = this.templateForMemberForm(memberData);
	            		}
	            		else {	                			    	            
	    	            	var $modal = $('.modal-desk');
	                    	$modal.find('.orderForm').hide();
	                    	$modal.find('.checkout').hide();
	                    	$modal.find('.newOrderSection').show();
	                    	//$modal.find('.memberSection').hide();

	                    	var data = this.model.toJSON();

	                    	data['members'] = [[${members}]];
	                        data['memberId'] = this.model.get("memberId");
	                        data['desks'] = DeskList.toJSON();
	                        data['rooms'] = RoomList.toJSON();
	                        data['payAmount'] = 0;
	                        data['payType'] = 0;
	                        data['payTypes'] = payTypes;
	                        data['pay'] = new PayModel().toJSON();
	                        data['deskStartDt'] = currentDate.valueOf();
	                        data['deskStartTm'] = currentDate.format('HH:mm:ss'); // '00:00:00';
	                        data['deskEndDt'] = currentDate.valueOf();
	                        data['deskEndTm'] = '23:59:59';
	                        
	                        DeskList.currentDeskModel = this.model;
	                        
	                        data['regDt'] = '';
	                    	data['postcode'] = '';
	                    	data['name'] = '';
	                    	data['tel'] = '';
	                    	data['telParent'] = '';
	                    	data['telEtc'] = '';
	                    	data['email'] = '';
	                    	data['birthDt'] = '';
	                    	data['gender'] = 1;
	                    	data['membershipNo'] = '';
	                    	data['no'] = '';
	                    	data['school'] = '';
	                    	data['address1'] = '';
	                    	data['address2'] = '';
	                    	data['addressDetail'] = '';	                    	
	                    	data['emailText'] = '';
	                    	data['emailAdd'] = '';	                    	
	                    	data['memberNote'] = '';
	                    	data['cabinet'] ='';
	                    	data['enterexitYes'] = 0;
	                    	data['smsYes'] = 0;
	                    	data['promotionYes'] = 0;
	                    	data['personalYn'] = 0;
	                    	data['utilYn'] = 0;
	                    	data['examType'] = -1;
	                    	data['examTypes'] = examTypes;
	                    	data['jobType'] = 0;
	                    	data['jobTypes'] = jobTypes;
	                    	data['interestType'] = 0;
	                    	data['interestTypes'] = interestTypes;
	                    	data['schoolGrade'] = 0;
	                    	data['schoolGrades'] = schoolGrades;
	                    	data['appMemberFlag'] = appMemberFlag;
	                    	data['timeYn'] = 0;
	                    	data['remainTime'] = 0;
	                    	
	                        var memberHtml = this.templateForMemberForm(data);
	            		}
	            		
	            	}
	            	else {
	            		var $modal = $('.modal-desk');
		            	$modal.find('.orderForm').show();
		            	$modal.find('.checkout').hide();
		            	$modal.find('.newOrderSection').hide();
		            				
		            	ReservationList.trigger('formReservation', reservations[0], ReservationList, MemberList, DeskList, RoomList, PayList, payTypes, flag, branchType, branchId, branchTel);
		            	//ReservationAllList.trigger('formReservation', reservations[0], ReservationList, MemberList, DeskList, RoomList, PayList, payTypes, flag, branchType, branchId, branchTel);
		            	
		            	var data = this.model.toJSON();
		            	            	
		            	data['members'] = [[${members}]];
		                data['memberId'] = this.model.get("memberId");
		                data['desks'] = DeskList.toJSON();
		                data['rooms'] = RoomList.toJSON();
		                data['payAmount'] = 0;
		                data['payType'] = this.model.get("payType");
		                data['payTypes'] = payTypes;
		                data['pay'] = new PayModel().toJSON();
		                data['deskStartDt'] = currentDate.valueOf();
		                data['deskStartTm'] = currentDate.format('HH:mm:ss'); // '00:00:00';
		                data['deskEndDt'] = currentDate.valueOf();
		                data['deskEndTm'] = '23:59:59';
		                data['examTypes'] = examTypes;
		                data['jobTypes'] = jobTypes;
    					data['interestTypes'] = interestTypes;
    					data['schoolGrades'] = schoolGrades;    					
		
		                DeskList.currentDeskModel = this.model;
		                
		                var memberId = reservations[0].get('memberId');
		                var memberData = MemberList.get(memberId).toJSON();
		                
		                memberData['examTypes'] = examTypes;
		                memberData['jobTypes'] = jobTypes;
    	                memberData['interestTypes'] = interestTypes;
    	                memberData['schoolGrades'] = schoolGrades;
    	                
    	                if (memberData.no.indexOf("C") != -1) {
    	                	appMemberFlag = true;
    	                }
    	                memberData['appMemberFlag'] = appMemberFlag;
    	                
    	                if (memberData['email'] == null || memberData['email'] == '') {
    	    				memberData['emailText'] = '';
    	    				memberData['emailAdd'] = '';
    	    			}
    	    			else {
    	    				var telStr = memberData['email'].split('@');
    	    				memberData['emailText'] = telStr[0];
    	    				memberData['emailAdd'] = telStr[1];
    	    			}
		            	var memberHtml = this.templateForMemberForm(memberData);
		            	
		            	
		            	
		            	
	            	}
	            	 
            	}            	
            	else {
            		var $modal = $('.modal-desk');
	            	$modal.find('.orderForm').show();
	            	$modal.find('.checkout').hide();
	            	$modal.find('.newOrderSection').hide();
	            				
	            	ReservationList.trigger('formReservation', reservations[0], ReservationList, MemberList, DeskList, RoomList, PayList, payTypes, flag, branchType, branchId, branchTel);
	            	//ReservationAllList.trigger('formReservation', reservations[0], ReservationList, MemberList, DeskList, RoomList, PayList, payTypes, flag, branchType, branchId, branchTel);
	            	
	            	var data = this.model.toJSON();
	            	            	
	            	data['members'] = [[${members}]];
	                data['memberId'] = this.model.get("memberId");
	                data['desks'] = DeskList.toJSON();
	                data['rooms'] = RoomList.toJSON();
	                data['payAmount'] = 0;
	                data['payType'] = this.model.get("payType");
	                data['payTypes'] = payTypes;
	                data['pay'] = new PayModel().toJSON();
	                data['deskStartDt'] = currentDate.valueOf();
	                data['deskStartTm'] = currentDate.format('HH:mm:ss'); // '00:00:00';
	                data['deskEndDt'] = currentDate.valueOf();
	                data['deskEndTm'] = '23:59:59';
	                
					
	                //examTemp = MemberList.filter({ memberId : reservations[0].get('memberId') });


	                DeskList.currentDeskModel = this.model;
	                
	                var memberId = reservations[0].get('memberId');
	                var memberData = MemberList.get(memberId).toJSON();
	                memberData['examTypes'] = examTypes;
	                memberData['jobTypes'] = jobTypes;
	                memberData['interestTypes'] = interestTypes;
	                memberData['schoolGrades'] = schoolGrades;
	                if (memberData.no.indexOf("C") != -1) {
	                	appMemberFlag = true;
	                }
	                memberData['appMemberFlag'] = appMemberFlag;
	                if (memberData['email'] == null || memberData['email'] == '') {
	    				memberData['emailText'] = '';
	    				memberData['emailAdd'] = '';
	    			}
	    			else {
	    				var telStr = memberData['email'].split('@');
	    				memberData['emailText'] = telStr[0];
	    				memberData['emailAdd'] = telStr[1];
	    			}
	            	var memberHtml = this.templateForMemberForm(memberData);
	            	
            	}
            	
            }
            //등록이 존재하지 않을 경우
            else {
            	//만기 회원이 존재할 경우
            	if(reservationsAll.length > 0) {
            		/* $('#btn-form-updateMember').show();
                	var reservationTrue = true;            	
                	
                	if ( branchType == 20 ) { //카페일 경우 일일 회원 퇴실처리를 한 데이터는 출력x	            	
    	            	var member = MemberList.filter({ memberId: reservations[0].attributes.memberId });
    	            	if (member[0].attributes.membershipNo != null && member[0].attributes.membershipNo.length >= 12) {
    	            		if (reservationsAll[0].attributes.checkoutYn == 0) {
    	            			
    	            			var $modal = $('.modal-desk');
    	    	            	$modal.find('.orderForm').show();
    	    	            	$modal.find('.checkout').show();
    	    	            	$modal.find('.newOrderSection').hide();
    	    	            				    	    	            	
    	    	            	ReservationAllList.trigger('formReservation', reservationsAll[0], ReservationAllList, MemberList, DeskList, RoomList, PayList, payTypes, flag, branchType, branchId, branchTel);
    	    	            	
    	    	            	var data = this.model.toJSON();	    	            	            	
   	    	            	
    	    	            	data['members'] = [[${members}]];
    	    	                data['memberId'] = this.model.get("memberId");
    	    	                data['desks'] = DeskList.toJSON();
    	    	                data['rooms'] = RoomList.toJSON();
    	    	                data['payAmount'] = 0;
    	    	                data['payType'] = this.model.get("payType");
    	    	                data['payTypes'] = payTypes;
    	    	                data['pay'] = new PayModel().toJSON();
    	    	                data['deskStartDt'] = currentDate.valueOf();
    	    	                data['deskStartTm'] = currentDate.format('HH:mm:ss'); // '00:00:00';
    	    	                data['deskEndDt'] = currentDate.valueOf();
    	    	                data['deskEndTm'] = '23:59:59';
    	    					data['examTypes'] = examTypes;
    	    					data['jobTypes'] = jobTypes;
    	    					data['interestTypes'] = interestTypes;
    	    					data['schoolGrades'] = schoolGrades;
    	    	                	
    	    	                DeskList.currentDeskModel = this.model;
    	    	                
    	    	                var memberId = reservations[0].get('memberId');
    	    	                var memberData = MemberList.get(memberId).toJSON();
    	    	                memberData['examTypes'] = examTypes;
    	    	                memberData['jobTypes'] = jobTypes;
    	    	                memberData['interestTypes'] = interestTypes;
    	    	                memberData['schoolGrades'] = schoolGrades;
    	    	                if (memberData.no.indexOf("C") != -1) {
    	    	                	appMemberFlag = true;
    	    	                }
    	    	                memberData['appMemberFlag'] = appMemberFlag;
    	    	                
    	    	    			if (memberData['email'] == null || memberData['email'] == '') {
    	    	    				memberData['emailText'] = '';
    	    	    				memberData['emailAdd'] = '';
    	    	    			}
    	    	    			else {
    	    	    				var telStr = memberData['email'].split('@');
    	    	    				memberData['emailText'] = telStr[0];
    	    	    				memberData['emailAdd'] = telStr[1];
    	    	    			}
    	    	            	var memberHtml = this.templateForMemberForm(memberData);
    	            		}
    	            		else {	                			    	            
    	    	            	var $modal = $('.modal-desk');
    	                    	$modal.find('.orderForm').hide();
    	                    	$modal.find('.checkout').hide();
    	                    	$modal.find('.newOrderSection').show();
    	                    	//$modal.find('.memberSection').hide();

    	                    	var data = this.model.toJSON();

    	                    	data['members'] = [[${members}]];
    	                        data['memberId'] = this.model.get("memberId");
    	                        data['desks'] = DeskList.toJSON();
    	                        data['rooms'] = RoomList.toJSON();
    	                        data['payAmount'] = 0;
    	                        data['payType'] = 0;
    	                        data['payTypes'] = payTypes;
    	                        data['pay'] = new PayModel().toJSON();
    	                        data['deskStartDt'] = currentDate.valueOf();
    	                        data['deskStartTm'] = currentDate.format('HH:mm:ss'); // '00:00:00';
    	                        data['deskEndDt'] = currentDate.valueOf();
    	                        data['deskEndTm'] = '23:59:59';
    	                        
    	                        DeskList.currentDeskModel = this.model;
    	                        
    	                        data['regDt'] = '';
    	                    	data['postcode'] = '';
    	                    	data['name'] = '';
    	                    	data['tel'] = '';
    	                    	data['telParent'] = '';
    	                    	data['telEtc'] = '';
    	                    	data['email'] = '';
    	                    	data['birthDt'] = '';
    	                    	data['gender'] = 1;
    	                    	data['membershipNo'] = '';
    	                    	data['no'] = '';
    	                    	data['school'] = '';
    	                    	data['address1'] = '';
    	                    	data['address2'] = '';
    	                    	data['addressDetail'] = '';	                    	
    	                    	data['emailText'] = '';
    	                    	data['emailAdd'] = '';	                    	
    	                    	data['memberNote'] = '';
    	                    	data['cabinet'] ='';
    	                    	data['enterexitYes'] = 0;
    	                    	data['smsYes'] = 0;
    	                    	data['promotionYes'] = 0;
    	                    	data['personalYn'] = 0;
    	                    	data['utilYn'] = 0;
    	                    	data['examType'] = -1;
    	                    	data['examTypes'] = examTypes;
    	                    	data['jobType'] = 0;
    	                    	data['jobTypes'] = jobTypes;
    	                    	data['interestType'] = 0;
    	                    	data['interestTypes'] = interestTypes;
    	                    	data['schoolGrade'] = 0;
    	                    	data['schoolGrades'] = schoolGrades;
    	                    	data['appMemberFlag'] = appMemberFlag;
    	                    	data['timeYn'] = 0;
    	                    	data['remainTime'] = 0;
    	                    	
    	                        var memberHtml = this.templateForMemberForm(data);
    	            		}
    	            		
    	            	}
    	            	else {
    	            		var $modal = $('.modal-desk');
    		            	$modal.find('.orderForm').show();
    		            	$modal.find('.checkout').hide();
    		            	$modal.find('.newOrderSection').hide();
    		            				    		            	
    		            	ReservationAllList.trigger('formReservation', reservationsAll[0], ReservationAllList, MemberList, DeskList, RoomList, PayList, payTypes, flag, branchType, branchId, branchTel);
    		            	
    		            	var data = this.model.toJSON();
    		            	            	
    		            	data['members'] = [[${members}]];
    		                data['memberId'] = this.model.get("memberId");
    		                data['desks'] = DeskList.toJSON();
    		                data['rooms'] = RoomList.toJSON();
    		                data['payAmount'] = 0;
    		                data['payType'] = this.model.get("payType");
    		                data['payTypes'] = payTypes;
    		                data['pay'] = new PayModel().toJSON();
    		                data['deskStartDt'] = currentDate.valueOf();
    		                data['deskStartTm'] = currentDate.format('HH:mm:ss'); // '00:00:00';
    		                data['deskEndDt'] = currentDate.valueOf();
    		                data['deskEndTm'] = '23:59:59';
    		                data['examTypes'] = examTypes;
    		                data['jobTypes'] = jobTypes;
        					data['interestTypes'] = interestTypes;
        					data['schoolGrades'] = schoolGrades;
    		
    		                DeskList.currentDeskModel = this.model;
    		                
    		                var memberId = reservationsAll[0].get('memberId');
    		                var memberData = MemberList.get(memberId).toJSON();
    		                
    		                memberData['examTypes'] = examTypes;
    		                memberData['jobTypes'] = jobTypes;
        	                memberData['interestTypes'] = interestTypes;
        	                memberData['schoolGrades'] = schoolGrades;
        	                if (memberData.no.indexOf("C") != -1) {
        	                	appMemberFlag = true;
        	                }
        	                memberData['appMemberFlag'] = appMemberFlag;
        	                
        	                if (memberData['email'] == null || memberData['email'] == '') {
        	    				memberData['emailText'] = '';
        	    				memberData['emailAdd'] = '';
        	    			}
        	    			else {
        	    				var telStr = memberData['email'].split('@');
        	    				memberData['emailText'] = telStr[0];
        	    				memberData['emailAdd'] = telStr[1];
        	    			}
    		            	var memberHtml = this.templateForMemberForm(memberData);
    		            	
    		            	
    		            	
    		            	
    	            	}
    	            	 
                	}            	
                	else {
                		var $modal = $('.modal-desk');
    	            	$modal.find('.orderForm').show();
    	            	$modal.find('.checkout').hide();
    	            	$modal.find('.newOrderSection').hide();
    	            				    	            	
    	            	ReservationAllList.trigger('formReservation', reservationsAll[0], ReservationAllList, MemberList, DeskList, RoomList, PayList, payTypes, flag, branchType, branchId, branchTel);
    	            	
    	            	var data = this.model.toJSON();
    	            	            	
    	            	data['members'] = [[${members}]];
    	                data['memberId'] = this.model.get("memberId");
    	                data['desks'] = DeskList.toJSON();
    	                data['rooms'] = RoomList.toJSON();
    	                data['payAmount'] = 0;
    	                data['payType'] = this.model.get("payType");
    	                data['payTypes'] = payTypes;
    	                data['pay'] = new PayModel().toJSON();
    	                data['deskStartDt'] = currentDate.valueOf();
    	                data['deskStartTm'] = currentDate.format('HH:mm:ss'); // '00:00:00';
    	                data['deskEndDt'] = currentDate.valueOf();
    	                data['deskEndTm'] = '23:59:59';
    	                
    					
    	                //examTemp = MemberList.filter({ memberId : reservations[0].get('memberId') });


    	                DeskList.currentDeskModel = this.model;
    	                
    	                var memberId = reservationsAll[0].get('memberId');
    	                var memberData = MemberList.get(memberId).toJSON();
    	                memberData['examTypes'] = examTypes;
    	                memberData['jobTypes'] = jobTypes;
    	                memberData['interestTypes'] = interestTypes;
    	                memberData['schoolGrades'] = schoolGrades;
    	                if (memberData.no.indexOf("C") != -1) {
    	                	appMemberFlag = true;
    	                }
    	                memberData['appMemberFlag'] = appMemberFlag;
    	                if (memberData['email'] == null || memberData['email'] == '') {
    	    				memberData['emailText'] = '';
    	    				memberData['emailAdd'] = '';
    	    			}
    	    			else {
    	    				var telStr = memberData['email'].split('@');
    	    				memberData['emailText'] = telStr[0];
    	    				memberData['emailAdd'] = telStr[1];
    	    			}
    	            	var memberHtml = this.templateForMemberForm(memberData);
    	            	
                	} */
            	} //만기 회원 로직 종료
		
            	
            	else { //만기 회원이 없을경우
            		$('#btn-form-updateMember').hide();
                	var reservationTrue = false;
                	
                	var $modal = $('.modal-desk');
                	$modal.find('.orderForm').hide();
                	$modal.find('.checkout').hide();
                	$modal.find('.newOrderSection').show();
                	//$modal.find('.memberSection').hide();

                	var data = this.model.toJSON();

                    //data['members'] = MemberList.toJSON();
                    data['members'] = [[${members}]];
                    data['memberId'] = this.model.get("memberId");
                    data['desks'] = DeskList.toJSON();
                    data['rooms'] = RoomList.toJSON();
                    data['payAmount'] = 0;
                    data['payType'] = 0;
                    data['payTypes'] = payTypes;
                    data['pay'] = new PayModel().toJSON();
                    data['deskStartDt'] = currentDate.valueOf();
                    data['deskStartTm'] = currentDate.format('HH:mm:ss'); // '00:00:00';
                    data['deskEndDt'] = currentDate.valueOf();
                    data['deskEndTm'] = '23:59:59';
                    
                    DeskList.currentDeskModel = this.model;
                    
                    data['regDt'] = '';
                	data['postcode'] = '';
                	data['name'] = '';
                	data['tel'] = '';
                	data['telParent'] = '';
                	data['telEtc'] = '';
                	data['email'] = '';
                	data['birthDt'] = '';
                	data['gender'] = 1;
                	data['membershipNo'] = '';
                	data['no'] = '';
                	data['school'] = '';
                	data['schoolGrade'] = 1;
                	data['address1'] = '';
                	data['address2'] = '';
                	data['addressDetail'] = '';
                	data['emailText'] = '';
                	data['emailAdd'] = '';
                	data['memberNote'] = '';
                	data['cabinet'] ='';
                	data['enterexitYes'] = 0;
                	data['smsYes'] = 0;
                	data['promotionYes'] = 0;
                	data['personalYn'] = 0;
                	data['utilYn'] = 0;
                	data['examType'] = -1;
                	data['examTypes'] = examTypes;
                	data['jobType'] = 0;
                	data['jobTypes'] = jobTypes;
                	data['interestType'] = 0;
                	data['interestTypes'] = interestTypes;
                	data['schoolGrade'] = 0;
                	data['schoolGrades'] = schoolGrades;
                	data['appMemberFlag'] = appMemberFlag;
                	data['timeYn'] = 0;
                	data['remainTime'] = 0;
                	
                    var memberHtml = this.templateForMemberForm(data);     
            	}
            	
  
                
			}
            
            //if끝
            
            
            	data['flag']  =  false; 
            	data['reservationNum'] = 1;
            	data['timeYn'] = 0;
            	var bodyHtml = this.templateForNewOrderForm(data);	            	
            	
                var deskId = this.model.get('deskId');
               
                
                $('#member-form')
                .one('show.bs.modal', function(e) {
                	
                	
                });
                
                
                $('.modal-desk')
                .one('show.bs.modal', function(e) {
                
                    var $modal = $(this);
                   	$modal.find('.member').html(memberHtml);
                   	
                   	//var $modal = $('#member-form');
                   	
               	 	// 회원번호 조회
    				var memberNo = [];
                    getMembersNo([[${branch.branchId}]], function(data){
                    	memberNo = data;                	
                    });
                    
                    $.validator.addMethod(
                        	'chkDuplicationMemberNo', function (value, element) {        		                
                        		var temp;
                        		var count = 0;
        		          		$.each(memberNo, function (index, item){
        		                	/*
        		          			if($('#no').val() == item) {
        		                		
        		                		return true;
        		                	}
        		                	else {
        		          				if(value == memberNo[index]) {
        		                			temp = memberNo[index];
        		                			return false;
        		                		}
        		                		else {
        		                			return true;
        		                		}
        		                	}
        		                	*/
        		                	if (reservationTrue == true) {
	        		                	if(value == memberNo[index]) {
	    		                			count++;
	        		                		if (count == 2) {
		        		                		temp = memberNo[index];
		    		                			return false;
	        		                		}
	        		                		return true;
	    		                		}
	    		                		else {
	    		                			return true;
	    		                		}
	        		                	
        		                	}
        		                	
        		                	if (reservationTrue == false) {
	        		                	if(value == memberNo[index]) {
	    		                			temp = memberNo[index];
	    		                			return false;
	    		                		}
	    		                		else {
	    		                			return true;
	    		                		}
	        		                	
        		                	}
	        		                	});
	        		          			return (value != temp);
	        		          		
                        	
        		          			
        		                	}, '회원번호가 이미 등록되어 있습니다'
                        );
                        
                        var originNo = $('input[name=membershipNo]').val();
                        $.validator.addMethod(
                            	'chkDuplicationForMembershipNo', function (value, element) {					
                            		var no = $('input[name=membershipNo]').val();
                            		if(originNo != no) { 
        	                    		var member = MemberList.findWhere({membershipNo: no});
        	        	            			if(member && member != '') return false;
        	        	            			else {
        	        	            				return true;
        	        	            			}
                            		}
                            		else return true;
        	        		                	}, '멤버십 번호가 다른 회원에 이미 등록되어 있습니다'
                            		
                	                	
                     	);
                        
                        $.validator.addMethod(
                            	'chkRegistrationForMembershipNo', function (value, element) {					
                            		var membershipno = $('input[name=membershipNo]').val();
                            		if (membershipno == null || membershipno == '') return true;
                            		var membershipCard = MembershipCardList.findWhere({membershipId: membershipno});                    		
                           				if(membershipCard ) return true;        	            			        	            	        	            			
               	            			else {
               	            				return false;
               	            			}

               		                	}, '멤버십 번호가 등록 되어있지 않습니다'

                     	);
                        
                        $.validator.addMethod(
                            	'chkNumeric', function (value, element) {					
                            		value = value.replace('C', '');
                            		return this.optional(element) || /^[0-9]+$/.test(value);
            		                
            		                	}, '숫자만 사용 가능합니다'
            		                	
                            );  
                       
                        $.validator.addMethod(
                            	'chkTel', function (value, element) {					
                            		if (value == null || value == '') return true;
                            		
                            		if (value.match('-')) {
                            			if (/^(?:(010-\d{4})|(01[1|6|7|8|9]-\d{3,4}))-(\d{4})$/.test(value)) {
                            				return true;
                            			} else {
                            				return false;	
                            			}
                            		} else {
                            			if (/^(?:(010\d{4})|(01[1|6|7|8|9]\d{3,4}))(\d{4})$/.test(value)) {
                            				return true;
                            			} else {
                            				return false;
                            			}
                            		}


               		                }, '휴대폰 번호의 형식이 올바르지 않습니다.'

                     	);
                        
                        
                        validatorMember = $modal.find('form').validate({
                			rules: {
                				no: {
                					required: true,
                					minlength: 4,
                					chkDuplicationMemberNo: true,
                					chkNumeric: true,
                				},
                				membershipNo: {
                					chkDuplicationForMembershipNo: true,
                					chkRegistrationForMembershipNo: true,
                				},
                				name: {
                					required: true,
                				},
                				tel:{
                					required: true,
                					chkTel: true,
                				},
                				telParent:{
                					chkTel: true,
                				},
                				gender:{
                					required: true,
                				},
                				schoolGrade:{
                					required: true,
                				},
                				
                			},
                			messages: {
                				no: {            	
                					required: "회원번호를 입력하세요",
                					minlength: "최소 4자리를 입력하세요",
                				},
                				name: {
                					required: "이름을 입력하세요",
                				},
                				tel:{
                					required: "전화번호를 입력하세요",
                				},
                				gender:{
                					required: "성별을 선택하세요",
                				},
                				schoolGrade:{
                					required: "학년을 선택하세요",
                				},
                				
                			}
                	    });      
                    
                   	
                    
                    $modal.find('.modal-title').text(title);
                    //$modal.find('.modal-body').html(bodyHtml);
                    $modal.find('.newOrder').html(bodyHtml);

                    $modal.find('.datepicker, .input-daterange').datepicker({
                        language: 'ko', autoclose: true, todayHighlight: true, format: datepickerFormat,

                    }).on('changeDate', function(e) {                    	
                    	var orgInputName = $(e.target).attr('data-org-input-name');
                        if (!(_.isEmpty(orgInputName))) {
                            var $orgInput = $('.modal-desk').find('[name=' + orgInputName + ']');
                            $orgInput.val(e.date.valueOf());

                        }
                        
                        if ( orgInputName == "deskStartDt") {
	                        d = new Date();
	                        //선택한 날짜와 현재 날짜가 같으면
	                        if ( (e.date.getYear().valueOf() == d.getYear().valueOf()) && (e.date.getDate().valueOf() == d.getDate().valueOf()) && (e.date.getDay().valueOf() == d.getDay().valueOf())) {
	                        	
	                        } else {
	                        	$modal.find('#deskStartTm').val("08:00");
	                        	var $deskStart = $modal.find('[name=deskStartTm]');
	                            $deskStart.val("08:00:00");
	                        	
	                        }
                        }
                        
                        //총 일수
                        var start = $('#deskStartDt').datepicker('getDate');
                        var end   = $('#deskEndDt').datepicker('getDate');
                        
                        var days = (end - start)/1000/60/60/24;
                        days = parseInt(days) + 1;
                        $('#dateCount').text('총 ' + days + '일');
                        
                    });

                    /*
                    $modal.find('#deskEndDt').datepicker({
                        language: 'ko', autoclose: true, todayHighlight: true, format: datepickerFormat,

                    }).on('changeDate', function(e) {
                    	var orgInputName = $(e.target).attr('data-org-input-name');
                        if (!(_.isEmpty(orgInputName))) {
                            var $orgInput = $('.modal-desk').find('[name=' + orgInputName + ']');
                            $orgInput.val(e.date.valueOf());

                        }
                        
                    });
					*/
                    
                    
                    $modal.find('#deskStartTm').clockpicker({
                        placement: 'bottom',
                        align: 'left',
                        autoclose: true,
                        donetext: '완료',
                    	'default': 'now',
                    	
                    }).on('change', function(e){
                    	if($modal.find('#deskStartDt').val() == $modal.find('#deskEndDt').val()) {
    	                	if ($modal.find('#deskStartTm').val() > $modal.find('#deskEndTm').val()) {
    	                		$modal.find('#deskEndTm').val($modal.find('#deskStartTm').val());
    	                	}                    	
                    	}
                    	var deskStartName = $(e.target).attr('time-org-input-name');
                        if (!(_.isEmpty(deskStartName))) {
                            var $deskStart = $modal.find('[name=' + deskStartName + ']');
                            $deskStart.val($('#deskStartTm').val() + ":00");

                        }             
                    });
                    	
                    $modal.find('#deskEndTm').clockpicker({
                        placement: 'bottom',
                        align: 'left',
                        autoclose: true,
                    	donetext: '완료',
                    	'default': 'now',
                    	
                    }).on('change', function(e){
                    	if($modal.find('#deskStartDt').val() == $modal.find('#deskEndDt').val()) {
    	                	if ($modal.find('#deskEndTm').val() < $modal.find('#deskStartTm').val()){
    	                		$modal.find('#deskStartTm').val($modal.find('#deskEndTm').val());
    	                	}
                    	}
                    	var deskEndName = $(e.target).attr('time-org-input-name');
                        if (!(_.isEmpty(deskEndName))) {
                            var $deskEnd = $modal.find('[name=' + deskEndName + ']');
                            $deskEnd.val($('#deskEndTm').val() + ":59");

                        }
                    });

                    
                    $modal.find('.chosen').chosen({width: "100%"
                    	}).on('change', function(e){
                            var $modal = $('.modal-desk');        					        	           
            	        	var memberData = MemberList.get($('#memberId').val()).toJSON();
            	        	 	        	
            	        	var tempTemplate = _.template($('#member-form-template').html());
            	        	memberData['appMemberFlag'] = appMemberFlag;
            	        	memberData['emailText'] = "";            	        	
            	        	memberData['emailAdd'] = "";
            	        	
            	        	var memberHtml = tempTemplate(memberData);
            	        	$modal.find('.member').html(memberHtml);            	        	
                                                     		
                    	}); 
                    
                    if (appMemberFlag == true) {
                    	$("#examType").attr('disabled', true).trigger("chosen:updated");
                    }                               

                    $modal.find('.deskReservationList,.deskEntryList').empty();
                    
                    //var reservations = ReservationList.filter({ deskId: deskId });

                    _.each(reservations, function(reservation){
            			
                        var view = new ReservationView({ model: reservation });
                        
                        var test = view.model.get('reservationId');
                        
                        $modal.find('.deskReservationList').append(view.render().el);
                        	
                        //}
                    });
                    
                    setScannerDetectionConfig($modal.find('#membership'), $('#branch-op-app'));

                    /*
                        var entries = EntryList.filter({ deskId: deskId });
                        _.each(entries, function(entry){
                            var view = new EntryView({ model: entry });
                            $modal.find('.deskEntryList').append(view.render().el);

                        });
                    */
                    $modal.find('[name=tel]').on('change', function() {
                        var no = $(this).val().replace(/-/g, '').substr(-4, 4);
                        $('#member-form').find('[name=no]').val(no);
                        $('#member-form').find('[name=no]').focus();
                        


                    });
                    
                })
                .one('hidden.bs.modal', function(e) {
                	setScannerDetectionConfig($('#membership-card-app #membership'), $('#membership-card-app'));
    				//location.reload();

                	
                })
                .modal();	
                
                //$('#member-form input, button').attr({ readonly: false , disabled: false });
                
            //}
            

        },
        formReservation: function(e) {
            var deskId = this.model.get('deskId');            
            var reservations = ReservationList.filter({ deskId: deskId });
        	
        	//ReservationList.trigger('formReservation', reservations[0], MemberList, DeskList, RoomList, PayList, payTypes, flag, e);        	
        },
        change: function() {
            var changedAttr = this.model.changedAttributes();
            if (_.difference(_.keys(changedAttr), ['t', 'l']).length == 0){
                // dragstop

            } else if (_.difference(_.keys(changedAttr), ['roomId']).length == 0){
                // dropped

            } else {
                this.render();						
            }

        },
        render: function() {
        	var data = this.model.toJSON();
        	this.el.id = data.deskId;

            this.$el.html(this.template(data));

            var status = 'empty';           
            
            this.$el
            .attr('data-status', status)            
            .css({
                top: data.t, left: data.l, height: data.h, width: data.w,
                position: 'absolute', cursor: 'pointer',
            });

            return this;

        },

    });

    var payTypes = [[${payTypes}]];



/*
    var PayView = Backbone.View.extend({
        tagName: 'div',
        className: 'pay',
        template: _.template($('#pay-template').html()),
        events: {
            'click .btn-view-pay': 'goViewPayPage',
        },
        initialize: function() {
            this.listenTo(this.model, 'change', this.change);
            this.listenTo(this.model, 'destroy', this.remove);

        },
        goViewPayPage: function(e) {
            var pay = this.model;

            var payDt = pay.get('payDt');
            var payStartDt = moment(payDt).format('YYYY-MM-DD');
            var payEndDt = payStartDt;

            var memberId = pay.get('memberId');

            location.assign(ctxRoot + 'branch/' + [[${branch.branchId}]] + '/pays?sPayStartDt=' + payStartDt +  '&sPayEndDt=' + payEndDt + '&sMember=' + memberId);

        },
        change: function() {
            this.render();

        },
        render: function() {
            var data = this.model.toJSON();

            data['member'] = MemberList.get(this.model.get('memberId')).toJSON();

            this.el.id = data.payId;

            this.$el.html(this.template(data));

            return this;

        },
    });
*/
	
// Reservation 예약회원 리스트
var ReservationList = new ReservationListCollection;
ReservationList.branchId = [[${branch.branchId}]];


var stateView = Backbone.View.extend({
    tagName: 'tr',
    className: 'reservation',
    template: _.template($('#stateList-template').html()),                    
    
    events: {
    	'click .btn-form-reservation' : 'formReservation'
    },
    initialize: function() {
        this.listenTo(this.model, 'change', this.change);
        this.listenTo(this.model, 'destroy', this.remove);
    },
    change: function() {
        this.render();

    },
    formReservation: function(e) {
    	
    	
    	$('#modal-list-form').modal('hide');
    	//var reservation = ReservationList.findWhere({memberId: memberId});
    	//$('.reservations #' + reservation.attributes.reservationId + '').trigger('click');
    	//ReservationList.trigger('formReservation', this.model, ReservationList, MemberList, DeskList, RoomList, PayList, payTypes, flag, branchType, branchId, branchTel);
    	
    	$('.reservations #' + this.model.attributes.reservationId + '').trigger('click');
    },
    render: function() {
    	
    	var reservation = this.model;
        var data = reservation.toJSON();

        var memberId = reservation.get('memberId');                
        var member = MemberList.get(memberId);
        
        
            if (branchType == 20 && member.attributes.membershipNo != null && member.attributes.membershipNo.length >= 12 && reservation.get('checkoutYn') == 1) {
        			return this;
        	}
        	else {
        		
        		var now = moment();

    			var strDeskStartDtTm = moment(reservation.get('deskStartDt')).format("YYYY-MM-DD") + reservation.get('deskStartTm');
    			var strDeskEndDtTm = moment(reservation.get('deskEndDt')).format("YYYY-MM-DD") + reservation.get('deskEndTm');

    			var deskStartDtTm = new moment(strDeskStartDtTm, 'YYYY-MM-DD HH:mm:ss');
    			var deskEndDtTm = new moment(strDeskEndDtTm, 'YYYY-MM-DD HH:mm:ss');
                
                	
                var deskId = reservation.get('deskId');
            	var reservations = ReservationList.filter({ deskId: deskId });
            	
            	var memberId = reservation.get('memberId');
                var member = MemberList.get(memberId);
                
                if(member) {
                    data['member'] = member.toJSON();
					
	                var Desk = DeskList.findWhere({deskId: data.deskId});
	                
	                // attributes : reservations의 roomId로 RoomList의 roomId 키값 입력
	                var Room = RoomList.findWhere({roomId: Desk.attributes.roomId});
	                
                    data['room'] = Room.toJSON();
                    data['desk'] = Desk.toJSON(); 
                    
	                this.el.id = data.reservationId;					
	                            	
            	}
                
                this.$el.html(this.template(data));
                
                if (now.isBefore(deskStartDtTm, deskEndDtTm)) {
	                		                 
    	            
                }
               	else {
               		
               	}
                
        	}
            
            return this;
    },
	
});
	
    // Reservation
    var ReservationList = new ReservationListCollection;
    ReservationList.branchId = [[${branch.branchId}]];

    var ReservationView = Backbone.View.extend({
        tagName: 'div',
        className: 'reservation',
        template: _.template($('#reservation-template').html()),
        timetemplate: _.template($('#reservation-template-time').html()),
        templateForMemberForm: _.template($('#member-form-template').html()),
        events: {
            'click .btn-view-reservation': 'goViewReservationPage',
            'click .btn-form-change-reservation': 'formReservation',
            'click .btn-deleteTest-reservation': 'deleteReservation',
            'dblclick': 'formReservation',
            
        },
        initialize: function() {
            this.listenTo(this.model, 'change', this.change);
            this.listenTo(this.model, 'destroy', this.remove);
        },
        goViewReservationPage: function(e) {
            var reservation = this.model;
			
            var reservationStartDt = moment(reservation.get('deskStartDt')).format('YYYY-MM-DD');
            var reservationEndDt = moment(reservation.get('deskEndDt')).format('YYYY-MM-DD');
            
            var memberId = reservation.get('memberId');

            var deskId = reservation.get('deskId');

            location.assign(ctxRoot + 'branch/' + [[${branch.branchId}]] + '/reservations?sReservationStartDt=' + reservationStartDt +  '&sReservationEndDt=' + reservationEndDt + '&sMember=' + memberId + '&sDesk=' + deskId);

        },
        change: function() {
            this.render();
            location.reload();////////////test

        },
        render: function() {
        	
        	var reservation = this.model;
			
        	if (reservation.attributes.checkoutYn == 0) {
	            var data = this.model.toJSON();
	
	            var member = MemberList.get(this.model.get('memberId'));
	            if (member) {
	
	            	data['member'] = member.toJSON();
	                if(reservation.get('reservationNum') > 1) {
	                    data['reservationNum'] = reservation.get('reservationNum');
	                }
	
	                this.el.id = data.reservationId;
	
	                var strDeskEndDt = moment(reservation.get('deskEndDt')).format("YYYY-MM-DD");
	                var deskEndTm = new moment(reservation.get('deskEndTm'), 'HH:mm:ss');
	
	                var strDeskEndDt = moment(reservation.get('deskEndDt')).format("YYYY-MM-DD");
	                if (moment().format('YYYY-MM-DD') == strDeskEndDt){
	                    
	                	//endDtate 가 당일
	                    var flag = moment(deskEndTm).fromNow().indexOf('후');
	                    if (flag == -1) {
	                        data['deskTime'] = moment(deskEndTm).fromNow() + ' 지남';
	                        data['flag'] = flag;
	                    }
	                    else {
	                        data['deskTime'] = moment(deskEndTm).fromNow() + ' 만기';
	                        data['flag'] = flag;
	                    }
						
	                    this.$el.html(this.timetemplate(data));
	                    //this.$el.html(this.freeSeattemplate(data));
	                }
	                else {
	                    //endDtate 가 당일이 아닌 경우
	                    this.$el.html(this.template(data));
	                }
	                             
	            }
        	}

        	
            return this;
            
        },
        formReservation: function(e) {
        	monthFlag = 0;
        	var appMemberFlag = false;
        	
        	$('.addReservation').hide();
        	var $modal = $('.modal-desk');

        	$modal.find('.orderForm').show();
        	$modal.find('.newOrderSection').hide();			
        	

        	var reservationId = e.delegateTarget.id;
			var reservations = ReservationList.filter({ reservationId: reservationId});
            var memberId = reservations[0].get('memberId');
            
        	var memberData = MemberList.get(memberId).toJSON();
        	if (branchType == 20 && memberData.membershipNo != null && memberData.membershipNo.length >= 12) {
        		if (reservations[0].get('checkoutYn') == 0) {
        			$modal.find('.checkout').show();
        		}
        		else {
        			$modal.find('.checkout').hide();
        		}
        	}
        	else {
        		$modal.find('.checkout').hide();
        	}
        	
            if (memberData['email'] == null || memberData['email'] == '') {
				memberData['emailText'] = '';
				memberData['emailAdd'] = '';
			}
			else {
				var telStr = memberData['email'].split('@');
				memberData['emailText'] = telStr[0];
				memberData['emailAdd'] = telStr[1];
			}
            if (memberData.no.indexOf("C") != -1) {
            	appMemberFlag = true;
            }
            memberData['appMemberFlag'] = appMemberFlag;
            
        	var memberHtml = this.templateForMemberForm(memberData);
        	
        	var $modal = $('.modal-desk');
        	$modal.find('.member').html(memberHtml);
        	ReservationList.trigger('formReservation', this.model, ReservationList, MemberList, DeskList, RoomList, PayList, payTypes, flag, branchType, branchId, branchTel);
        	
        	//        	this.formMember(e);
        },
        deleteReservation: function() {
        	//console.log(model.paysOfOrder);
        	//console.log(model.reservationsOfOrder);
        	
        	//alert('testa');
        	
        	/*
        	reservationModels = model.reservationsOfOrder;
        	payModels = model.paysOfOrder;

        	var $modal = $('#modal-order-form');
        	if(confirm('정말로 삭제하시겠습니까?')) {
	        	reservationModels.forEach(function(item) {
	        		currentReservationModel = item;
		        	this.currentReservationModel.destroy({
	                wait: true,
	                success: function (model, response) {
	                
		        	},
		        	
		        	});
	        	});            	
		        	payModels.forEach(function(item) {
	                	currentPayOfOrderModel = item;		                	
			        	this.currentPayOfOrderModel.destroy({
		                wait: true,
		                success: function (model, response) {
		                		                    
		
		                },
		
			        	});
		        	});
		        //$modal.modal('hide');
		        location.reload();
        	}
        	*/
        },
        
//         formMember: function(e) {
//         	var reservationId = e.delegateTarget.id;
// 			var reservations = ReservationList.filter({ reservationId: reservationId});
//             var memberId = reservations[0].get('memberId');
            
//         	var memberData = MemberList.get(memberId).toJSON();        	
//         	var memberHtml = this.templateForMemberForm(memberData);
        	
//         	var $modal = $('.modal-desk');
//         	$modal.find('.member').html(memberHtml);
            
// 		},
		
    });
    
    var DeskReservationView = Backbone.View.extend({
        tagName: 'tr',
        className: 'reservation',
        template: _.template($('#desk-reservation-template').html()),
        template2: _.template($('#desk-reservation-template2').html()),
        templateForfreeSeat: _.template($('#freeSeat-template').html()),
        templateForNewOrderForm: _.template($('#new-order-form-template').html()),        
        events: {
        	//'click .btn-form-reservation' : 'formFreeSeat',
        	//'click' : 'formFreeSeat',
        	//'click .btn-form-freeSeat' : 'saveFreeSeat'
			'click .btn-form-reservation' : 'formReservation'			
            
        },
        initialize: function() {
            this.listenTo(this.model, 'change', this.change);
            this.listenTo(this.model, 'destroy', this.remove);

        },
        change: function() {
            this.render();

        },
        saveFreeSeat: function() {
        	var values = {};
            var $modal = $('#modal-freeSeat-form');
          	//var $form = $modal.find('form');
            
            //if($form.valid()) {
	            var $inputs = $modal.find(':input');
	            $inputs.each(function(i, element) {
	                var $element = $(element);
	                if ($element.is('[type=radio]')) {
	                    if ($element.is(':checked')) {
	                        var name = $element.attr('name');
	                        if (!(_.isEmpty(name))) {
	                            values[name] = $element.val();
	
	                        }
	                    }
	
	                } else {
	                    var name = $element.attr('name');
	                    if (!(_.isEmpty(name))) {
	                        values[name] = $element.val();
	
	                    }
	
	                }
	            });
	
	            this.model.save(values, {
	                wait: true,
	                success: function (model, response) {
	                    $modal.modal('hide');
	                },
	
	            });
            //}
			
        },
        formReservation: function(e) {
        	$('#modal-freeSeat-form').modal('hide');
        	ReservationList.trigger('formReservation', this.model, ReservationList, MemberList, DeskList, RoomList, PayList, payTypes, flag, branchType, branchId, branchTel);
        },
        render: function() {
        	
        	//asdf
        	var reservation = this.model;
            var data = reservation.toJSON();

            var memberId = reservation.get('memberId');                
            var member = MemberList.get(memberId);
                     
            var payStatus;
            //미수금이 있으면 status 변경
            //var pays = PayList.filter({ orderId: reservation.attributes.orderId });
            var pays = PayList.filter({ reservationId: reservation.attributes.reservationId });
            _.each(pays, function(pay){
    			if (pay.attributes.payType == 3 && pay.attributes.payStateType != 0) { //미수금
    				payStatus = 'receivable';
    				return;
    			}

            });
            
            
	            if (branchType == 20 && member.attributes.membershipNo != null && member.attributes.membershipNo.length >= 12 && reservation.get('checkoutYn') == 1) {
	        			return this;
	        	}
	        	else {
	        		
	        		var now = moment();
	
	    			var strDeskStartDtTm = moment(reservation.get('deskStartDt')).format("YYYY-MM-DD") + reservation.get('deskStartTm');
	    			var strDeskEndDtTm = moment(reservation.get('deskEndDt')).format("YYYY-MM-DD") + reservation.get('deskEndTm');
	
	    			var deskStartDtTm = new moment(strDeskStartDtTm, 'YYYY-MM-DD HH:mm:ss');
	    			var deskEndDtTm = new moment(strDeskEndDtTm, 'YYYY-MM-DD HH:mm:ss');
	    			data['deskEndDt'] = reservation.get('deskEndDt');
	    			
	    			if (now.isBetween(deskStartDtTm, deskEndDtTm)) {
	                    
	                    if(member) {
	                        data['member'] = member.toJSON();
	    					
	                        data['reservationNum'] = reservation.get('reservationNum');
	                        
	                        
	                        //자유석일 경우
	                        if (data.deskId == null || data.deskId == ''){
	                        	//var diff = moment(deskEndDtTm).diff(moment(), 'days');
	    	                    
	                        	data['room'] = "";
	                        	//data['diff'] = diff;
	                        	
	                        	this.el.id = data.reservationId;
	                        	this.$el.html(this.templateForfreeSeat(data));
	                        	
	                        	if(data.reservationStatus != 20) this.$el.find('span').addClass('text-muted text-strike');
	    					}
	    					//자유석이 아닐 경우
	                        else {
	    						var diff = moment(deskEndDtTm).diff(moment(), 'days');
	    	                    var status = 'reserved';
	    	                    var remain_status = (diff <= 1) ? 'below-1' : (diff <= 4 ? 'below-4' : (diff <= 7 ? 'below-7' : ''));
	    	                    
		    					
	    	                    
	    	                    data['diff'] = diff;
	    	
	    	                    this.$el.attr({
	    	                        'data-status': status,
	    	                        'pay-status' : payStatus,
	    	                        'data-remain-status': remain_status,
	    	                        'data-member-id': memberId,
	    	                    });
	    	                    
	    	                    
	    	                    this.el.id = data.reservationId;
	    	                    if (diff < 3) {
	    	                    	this.$el.html(this.template2(data));
		    	                    //x.style.color = "red";	
	    	                    } else {
	    	                    	this.$el.html(this.template(data));	
	    	                    }
	    	                    
	    	                    
	    	                    
	    	                     


	    					}
	                    }
	
	               	}
	    			else if (now.isBefore(deskStartDtTm, deskEndDtTm)) {
	                	var deskId = reservation.get('deskId');
	                	var reservations = ReservationList.filter({ deskId: deskId });
	                	
	                	var memberId = reservation.get('memberId');
	                    var member = MemberList.get(memberId);
	                    if(member) {
	                        data['member'] = member.toJSON();
	    					
	                        data['reservationNum'] = reservation.get('reservationNum');
	                        
	                      	//자유석일 경우
	                        if (data.deskId == null || data.deskId == ''){
	                        	data['room'] = "";
	                        	//data['diff'] = diff;
	                        	
	                        	this.el.id = data.reservationId;
	                        	this.$el.html(this.templateForfreeSeat(data));
	                        	
	                        	if(data.reservationStatus != 20) this.$el.find('span').addClass('text-muted text-strike');
	                        }
	                        else {
	                        
		    					var diff = moment(deskEndDtTm).diff(moment(), 'days');
		    	                var status = 'to-be-reserved';
		    	                var remain_status = (diff <= 1) ? 'below-1' : (diff <= 4 ? 'below-4' : (diff <= 7 ? 'below-7' : ''));
		    	
		    	                data['diff'] = diff;
		    	
		    	                this.$el.attr({
		    	                    'data-status': status,
		    	                    'pay-status' : payStatus,
		    	                    'data-remain-status': remain_status,
		    	                    'data-member-id': memberId,
		    	                });
		    	                
		    	                this.el.id = data.reservationId;					
		    	                if (diff < 3) {
	    	                    	this.$el.html(this.template2(data));
		    	                    //x.style.color = "red";	
	    	                    } else {
	    	                    	this.$el.html(this.template(data));	
	    	                    }
	                        }
	    	            }
	                    
	                }
	    			else if(now.isAfter(deskEndDtTm)) {
	    				/* var deskId = reservation.get('deskId');
	                	var reservations = ReservationList.filter({ deskId: deskId });
	                	
	                	var memberId = reservation.get('memberId');
	                    var member = MemberList.get(memberId);
	                    if(member) {
	                        data['member'] = member.toJSON();
	    					
	                        data['reservationNum'] = reservation.get('reservationNum');
	                        
	                      	//자유석일 경우
	                        if (data.deskId == null || data.deskId == ''){
	                        	data['room'] = "";
	                        	//data['diff'] = diff;
	                        	
	                        	this.el.id = data.reservationId;
	                        	this.$el.html(this.templateForfreeSeat(data));
	                        	
	                        	if(data.reservationStatus != 20) this.$el.find('span').addClass('text-muted text-strike');
	                        }
	                        else {
		    					var diff = moment(deskEndDtTm).diff(moment(), 'days');
		    	                var status = 'expired';
		    	                //var remain_status = (diff <= 1 && diff > -1) ? 'below-1' : (diff <= 4 ? 'below-4' : (diff <= 7 ? 'below-7' : ''));
		    	                var remain_status = 'expired';
		    	                
		    	                data['diff'] = diff;
		    	
		    	                this.$el.attr({
		    	                    'data-status': status,
		    	                    'pay-status' : payStatus,
		    	                    'data-remain-status': remain_status,
		    	                    'data-member-id': memberId,
		    	                });
		    	                
		    	                this.el.id = data.reservationId;					
		    	                if (diff < 3) {
	    	                    	this.$el.html(this.template2(data));
		    	                    //x.style.color = "red";	
	    	                    } else {
	    	                    	this.$el.html(this.template(data));	
	    	                    }
	                        }
	    	            } */
	    			} 
	    			else {
	    				
	    			}
	                return this;
	        	}
	            return this;
        },

    });

    

    var MemberView = Backbone.View.extend({
        tagName: 'div',
        className: 'member',
        template: _.template($('#member-template').html()),
        events: {
            'dblclick' : 'formMember',
        },
        initialize: function() {
            this.listenTo(this.model, 'change', this.render);
            this.listenTo(this.model, 'destroy', this.remove);

        },
        render: function() {
            var data = this.model.toJSON();
            data['index'] = MemberList.indexOf(this.model);

            this.el.id = data.memberId;

            this.$el.html(this.template(data));

            return this;

        },
        formMember: function(e) {
            MemberList.trigger('formMember', this.model);

        },
    });

    // Entry
    var EntryList = new EntryListCollection();
    EntryList.branchId = [[${branch.branchId}]];

    var EntryView = Backbone.View.extend({
        tagName: 'a',
        className: 'entry list-group-item list-group-item-action',
        template: _.template($('#entry-template').html()),
        events: {
            'click': 'click',
            
        },
        initialize: function() {
            this.listenTo(this.model, 'change', this.change);
            this.listenTo(this.model, 'destroy', this.remove);

        },
        click: function() {

        },
        change: function() {
            this.render();

        },
        render: function() {            
        				        
            //현재 날짜
        	var Now = new Date(); 
			currentDate = Now.getFullYear() + '-' + (Now.getMonth() +1 < 10? "0" +  (Now.getMonth() +1): Now.getMonth() +1 ) + '-' +  (Now.getDate() < 10? "0" +  Now.getDate(): Now.getDate());

            
			//새벽 00:00 ~ 02:00 데이터는 출력 하지 않음
        	//if (moment(this.model.get('entryDt')) >= moment(currentDate+' 00:00:00') && moment(this.model.get('entryDt')) <= moment(currentDate+' 02:40:00')){
        		//return this.$el.html();
        	//}
        	//else {
	        	var data = this.model.toJSON();
	            
	            data['member'] = MemberList.get(this.model.get('memberId')).toJSON();
	
	            this.$el.html(this.template(data));
	            return this;
        	//}
            

        },
    });


    // Order
    var OrderList = new OrderListCollection();
    OrderList.branchId = [[${branch.branchId}]];


    // Branch Op
    
    var BranchOpView = Backbone.View.extend({
        el: $('#branch-op-app'),
        templateForNewMemberForm: _.template($('#member-form-template').html()),
        templateForStats: _.template($('#stats-template').html()),
        templateForReservationForm: _.template($('#order-form-template').html()),
        templateForNewOrderForm: _.template($('#new-order-form-template').html()),        
        currrentFormReservationApp: null,
        events: {
            'click #btn-new-member' : 'formNewMember',
            'click #btn-save-new-member': 'saveNewMember',
            'click #btn-new-pay' : 'goPayPage',
            //'click #btn-new-reservation' : 'goReservationPage',
            'click #btn-new-order' : 'saveNewOrder',
            'click #btn-cancel-new-order' : 'cancelSaveNewOrder',
        	'click #btn-search-membership' : 'scannerDetected',
        	'scannerDetected' : 'scannerDetected',
 			'click #btn-form-freeSeat' : 'formFreeSeatlist',
			'click #btn-new-reservation' : 'newReservation',       			  
			'keyup #payAmount' : 'keyup',
//             'click .btn-form-change-reservation': 'formReservationOfOrder',
			'click .btn-deleteTest-reservation': 'deleteReservation',
			'click .newReservation.btn-set-time' : 'setNewReservationTime',
			'click #searchPostcode' : 'test',
			'click #btn-form-toBeReservation' : 'formToBeReservation',
			'click #btn-form-updateMember': 'updateMemberInfo', 
			'click #receivable' : 'asdf',
					
				
        },
        
        asdf: function() {
        	alert('asdf');
        },

        
        test: function() {
        	//$('#searchPostcode').click(function() {  

        		new daum.Postcode({
                    oncomplete: function(data) {
                    	//console.log(data);
                        // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

                        // 각 주소의 노출 규칙에 따라 주소를 조합한다.
                        // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
                        var fullAddr = ''; // 최종 주소 변수
                        var fullAddr2 = ''; // 최종 주소 변수2
                        var extraAddr = ''; // 조합형 주소 변수

                        // 사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
                        if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우
                            fullAddr = data.roadAddress;
                            
        	                if (data.autoJibunAddress.length > 2) {	                		
        	                	fullAddr2 = data.autoJibunAddress;
        	                } else {
        	                	fullAddr2 = data.jibunAddress;	                    	
        	                }
        	                
                        } else { // 사용자가 지번 주소를 선택했을 경우(J)
                        	if (data.autoRoadAddress.length > 2) {	                		
                        		fullAddr = data.autoRoadAddress;
                        	} else {
                        		fullAddr = data.roadAddress;                				
                        	}
                                        	
                        	fullAddr2 = data.jibunAddress;
                        }
                        //console.log(fullAddr2);
                        // 사용자가 선택한 주소가 도로명 타입일때 조합한다.
                        if(data.userSelectedType === 'R'){
                            //법정동명이 있을 경우 추가한다.
                            if(data.bname !== ''){
                                extraAddr += data.bname;
                            }
                            // 건물명이 있을 경우 추가한다.
                            if(data.buildingName !== ''){
                                extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                            }
                            // 조합형주소의 유무에 따라 양쪽에 괄호를 추가하여 최종 주소를 만든다.
                            fullAddr += (extraAddr !== '' ? ' ('+ extraAddr +')' : '');
                        }

                        // 우편번호와 주소 정보를 해당 필드에 넣는다.
                        //document.getElementById('postcode').value = data.zonecode; //5자리 새우편번호 사용
                        //document.getElementById('address1').value = fullAddr;
                        //document.getElementById('address2').value = fullAddr2;
                        
                        $('#modal-new-member-form .modal-body #postcode').val(data.zonecode);
                        $('#modal-new-member-form .modal-body #address1').val(fullAddr);
                        $('#modal-new-member-form .modal-body #address2').val(fullAddr2);
                        $('#modal-new-member-form .modal-body #addressDetail').focus();
                        //$modal.find('#postcode').val() = data.zonecode;
                        
        				//$('#postcode').val(data.zonecode);
        				//$('#postcode').text(data.zonecode);
        				//$('#address').val(fullAddr);
        				//$('#address').text(fullAddr);
                        
                        
                        // 커서를 상세주소 필드로 이동한다.
                        //document.getElementById('addressDetail').focus();
                        //$('#addressDetail').focus();
                    }
                }).open();
        		
        	
        	//});
        	
        },
        
        initialize: function(reservation) {
            this.listenTo(RoomList, 'add', this.addOneRoom);
            this.listenTo(DeskList, 'add', this.addOneDesk);
            //this.listenTo(MemberList, 'add', this.addOneMember);
            //this.listenTo(PayList, 'add', this.addOnePay);
            this.listenTo(ReservationList, 'add', this.addOneReservation);
            this.listenTo(ReservationAllList, 'add', this.addOneReservationAll);
            this.listenTo(EntryList, 'add', this.addOneEntry);

            this.listenTo(RoomList, 'reset', this.resetRoom);
            this.listenTo(DeskList, 'reset', this.resetDesk);
            //this.listenTo(MemberList, 'reset', this.resetMember);
            //this.listenTo(PayList, 'reset', this.resetPay);
            this.listenTo(ReservationList, 'reset', this.resetReservation);
            this.listenTo(ReservationAllList, 'reset', this.resetReservationAll);
            
            this.listenTo(EntryList, 'reset', this.resetEntry);
            this.listenTo(ReservationList, 'formReservation', this.formReservation);
            this.listenTo(ReservationAllList, 'formReservation', this.formReservation);
        },
        render: function() {

        },        
        refreshStats: function() {
        	var deskMax = 0
        	_.each(DeskList.models, function(desk){
        		deskMax = deskMax + desk.get('deskMax');
        	});
        	
            var $reservations = this.$('.reservation');
            var $desks = this.$('.desk');
            var data = {
                //'countOfTotal': this.$('.desk').length,                
                'countOfTotal': deskMax,
                'countOfReserved' : $reservations.filter('[data-status=reserved]').length,
                'countOfTobereserved' : $reservations.filter('[data-status=to-be-reserved]').length,
                'countOfOut' : $reservations.filter('[data-status=out]').length,
                'countOfIn' : $reservations.filter('[data-status=in]').length,
                'countOfOuting' : $reservations.filter('[data-status=outing]').length,
                'countOfBelow7' : $reservations.filter('[data-remain-status=below-7]').length,
                'countOfBelow4' : $reservations.filter('[data-remain-status=below-4]').length,
                'countOfBelow1' : $reservations.filter('[data-remain-status=below-1]').length,
                'countOfReceivable' : $reservations.filter('[pay-status=receivable]').length,
            };

            var html = this.templateForStats(data);

            $('#stats').html(html);
            
          	//미방문 리스트
            _.each( $reservations.filter('[data-status=reserved]'), function(reservation){            	
            	var reservation = ReservationList.filter({ reservationId : reservation.id});
            	var view = new stateView({ model: reservation[0] });
    			this.$('#reserved-list').append(view.render().el);			
            });
            
          	//학습후 퇴실 리스트
            _.each( $reservations.filter('[data-status=out]'), function(reservation){            	
            	var reservation = ReservationList.filter({ reservationId : reservation.id});
            	var view = new stateView({ model: reservation[0] });
    			this.$('#out-list').append(view.render().el);			
            });
            
            //학습중 리스트
            _.each( $reservations.filter('[data-status=in]'), function(reservation){            	
            	var reservation = ReservationList.filter({ reservationId : reservation.id});
            	var view = new stateView({ model: reservation[0] });
    			this.$('#in-list').append(view.render().el);			
            });
            
          	//휴식 리스트
            _.each( $reservations.filter('[data-status=outing]'), function(reservation){            	
            	var reservation = ReservationList.filter({ reservationId : reservation.id});
            	var view = new stateView({ model: reservation[0] });
    			this.$('#outing-list').append(view.render().el);			
            });
          	
          	//잔여7일 리스트
            _.each( $reservations.filter('[data-remain-status=below-7]'), function(reservation){            	
            	var reservation = ReservationList.filter({ reservationId : reservation.id});
            	var view = new stateView({ model: reservation[0] });
    			this.$('#below-7-list').append(view.render().el);			
            });

          	//잔여4일 리스트
            _.each( $reservations.filter('[data-remain-status=below-4]'), function(reservation){            	
            	var reservation = ReservationList.filter({ reservationId : reservation.id});
            	var view = new stateView({ model: reservation[0] });
    			this.$('#below-4-list').append(view.render().el);			
            });          	
          	
          	//잔여1일 리스트
            _.each( $reservations.filter('[data-remain-status=below-1]'), function(reservation){            	
            	var reservation = ReservationList.filter({ reservationId : reservation.id});
            	var view = new stateView({ model: reservation[0] });
    			this.$('#below-1-list').append(view.render().el);			
            });
          	
          	//미수금 리스트
            _.each( $reservations.filter('[pay-status=receivable]'), function(reservation){            	
            	var reservation = ReservationList.filter({ reservationId : reservation.id});
            	var view = new stateView({ model: reservation[0] });
    			this.$('#receivable-list').append(view.render().el);			
            });
          	
        },
        
        updateMemberInfo : function() {
        	 
        	var memberNo = [];
            getMembersNo([[${branch.branchId}]], function(data){
            	memberNo = data;                	
            });
            
            var values = {};
			var $modal = $('#member-form');
        	var $form = $modal.find('form');
            
        	
            
			if ($modal.valid()) {
					var $inputs = $modal.find(':input');
		            $inputs.each(function(i, element) {
		                var $element = $(element);
		                if ($element.is('[type=radio]')) {
		                    if ($element.is(':checked')) {
		                        values[$element.attr('name')] = $element.val();
		                        console.log($element.attr('type') + " : " +$element.val());
		                    }
		                   	                }
		                else if( $element.is('[type=checkbox]')){
		                	
		                	var chk = $(this).is(":checked");//.attr('checked');
		                    if(chk){ 
		                    	
		                    	values[$element.attr('name')] = "1";
		                    }
		                   else{  
		                	   values[$element.attr('name')] = "0";
		                   }
		                }
		                else {
		                    var name = $element.attr('name');
		                  
		                    if (!(_.isEmpty(name))) {
		                        values[name] = $element.val();
		                    }
		
		                }
		            });
		           
		           
		            values['remainTime'] = parseInt(values['remainTime']) + parseInt(values['remainTimeAdd']);
		            
		            if (values['membershipNo'] == '') values['membershipNo'] = null; 
		            
		            if (values['emailAdd'] == "") {
		            	values['emailAdd'] = values['emailAddText'];
		            }
		            if(values['emailText']) {
		            	values['email'] = values['emailText'] + '@' + values['emailAdd'];
		            }
		            
		            var no = values['no'];
		            
		            var Member = MemberList.findWhere({ no : no})
		            
		            	Member.save(values, {
		                wait: true,
		                success: function (model, response) {
		                	//$modal.modal('hide');
		                	alert('회원정보 수정완료');
		                },
		
		            });

			}
			
            
			
        },
        
        formFreeSeatlist: function() {
        	$('#modal-freeSeat-form')
        	.one('show.bs.modal', function(e) {
        		var $modal = $(this);
        		$modal.find('.modal-title').html('자유석 리스트');
        	})
        	.one('hidden.bs.modal', function(e) {
        		//location.reload();
        	})        	
        	.modal();
        },
        
        formToBeReservation : function() {
        	$('#modal-list-form').one('show.bs.modal', function(e) {        	        		
        		var $modal = $(this);
        		$modal.find('.modal-title').html('예약회원 리스트');
        		$modal.find('#toBeReservation-list').show();
        		$modal.find('#reserved-list').hide();
        	})
        	.one('hidden.bs.modal', function(e) {
        		//location.reload();
        	})        	
        	.modal();
        },
        
        setNewReservationTime: function(e) {
        	var $btn = $(e.currentTarget);
            var $form = $btn.parentsUntil('form').last().parent();

            var unit = $btn.attr('data-add-unit');
            var value = $btn.attr('data-add-value');
            if(unit == 'h') {
                var deskStartDt = $form.find('#deskStartDt').val();
                var deskStartTm = $form.find('#deskStartTm').val();

                var deskEndTmDt = moment(deskStartDt + ' ' + deskStartTm, momentDatepickerFormat + ' ' + momentClockpickerFormat).add(value, unit);
                
                $form.find('#deskEndDt').datepicker('setDate', deskEndTmDt.format(momentDatepickerFormat));
//                 $form.find('#deskEndDt').val(deskEndTmDt.format(momentDatepickerFormat))
//                 						.trigger($.Event('changeDate', { date:deskEndTmDt.toDate()}));
                $form.find('#deskEndTm').val(deskEndTmDt.format(momentClockpickerFormat))
                						.trigger('change');

            } else if(unit == 'd') {
                var deskStartDt = $form.find('#deskStartDt').val();

                if(value == "1") {
                    // 당일
                    var d = moment(deskStartDt, momentDatepickerFormat);
                    $form.find('#deskEndDt').datepicker('setDate', d.format(momentDatepickerFormat));

                } else {
                    // 며칠
                    var d = moment(deskStartDt, momentDatepickerFormat).add(value, unit);
                    $form.find('#deskEndDt').datepicker('setDate', d.format(momentDatepickerFormat));

                }

                $form.find('#deskEndTm').val('23:59')
                						.trigger('change');

            } else if(unit == 'M') {
                var deskStartDt = $form.find('#deskStartDt').val();                
                
                /*
                var d = moment(deskStartDt, momentDatepickerFormat).add(-1, 'd').add(value, unit);                
                
                $form.find('#deskEndDt').datepicker('setDate', d.format(momentDatepickerFormat));
                
//                 $form.find('#deskEndDt').trigger($.Event('changeDate', { date:d.toDate()}))
//                 						.val(d.format(momentDatepickerFormat));
				*/
				
                var d = moment(deskStartDt, momentDatepickerFormat).add(-1, 'd').add(value, unit);
                $form.find('#deskEndDt').val(d.format(momentDatepickerFormat))
                						.trigger($.Event('changeDate', { date:d.toDate()}));

                $form.find('#deskEndTm').val('23:59')
		                				.trigger('change');
               


            } else if(unit == 'PM') {
            	var deskStartDt = $form.find('#deskStartDt').val();
            	var deskEndDt = $form.find('#deskEndDt').val();
            	
            	if(value == "1") {
            		//+1일
                    var d = moment(deskEndDt, momentDatepickerFormat).add(value, 'd'); 
                    $form.find('#deskEndDt').datepicker('setDate', d.format(momentDatepickerFormat));
                    
//                     $form.find('#deskEndTm').val('23:59')
//     										.trigger('change');
            	}
            	else if (value == "-1") {
					//-1일
                    var d = moment(deskEndDt, momentDatepickerFormat).add(value, 'd');
                    $form.find('#deskEndDt').datepicker('setDate', d.format(momentDatepickerFormat));

//                     $form.find('#deskEndTm').val('23:59')
//     		                				.trigger('change');
            	}
            	else if(value == "2") {
            		monthFlag++;
            		if (monthFlag==1) {
            			var deskDt = deskStartDt.replace(/ /g, '');
            		}
            		else if (monthFlag > 1) {
            			var deskDt = deskEndDt.replace(/ /g, '');
            		}
            		var regMonth = deskDt.substring(5,7);
            		regMonth = regMonth.replace('월', '');
            		
					//몇월인지 구분
            		if(regMonth == 1 || regMonth == 3 || regMonth == 5 || regMonth == 7 || regMonth == 8 || regMonth == 10 || regMonth == 12) { //31일
            		
            			if (monthFlag==1) {
            				var d = moment(deskEndDt, momentDatepickerFormat).add(30, 'd');
            			}
            			else if (monthFlag > 1) {
            				var d = moment(deskEndDt, momentDatepickerFormat).add(31, 'd');
            			}
            			
            		}
            		else if (regMonth == 2 || regMonth == 4 || regMonth == 6 || regMonth == 9 || regMonth == 11) { //30일            			
            			if (regMonth == 2) {
            				var d = moment(deskEndDt, momentDatepickerFormat).add(moment(deskEndDt, momentDatepickerFormat).daysInMonth(), 'd');
            			}
            			else {	
	            			if (monthFlag==1) {
	            				var d = moment(deskEndDt, momentDatepickerFormat).add(29, 'd');
	            			}
	            			else if (monthFlag > 1) {
	            				var d = moment(deskEndDt, momentDatepickerFormat).add(30, 'd');
	            			}
            			}
            		}
            			
            		 
                    $form.find('#deskEndDt').datepicker('setDate', d.format(momentDatepickerFormat));
            	}
            }
        },
        scannerDetected: function() {
        	var no = this.$('#membership').val();
        	var member = MemberList.findWhere({membershipNo: no});
        	
        	if (member == null) {
        	    member = MemberList.findWhere({no: no});

            	if (member == null) {
            	
            		member = MemberList.findWhere({name: no});
            		if (member == null) {
            			alert('등록된 멤버십번호 또는 회원번호가 없습니다');
            			return;
            		}

            	}
        	}

            this.$('#membership').val('');

        	var memberId = member.get('memberId');
        	this.$('#memberId').val(memberId).trigger('chosen:updated');

		},
        reservationNum: function() {
        	var now = moment();
        	var data = {};

        	_.each(ReservationList.models, function(reservation){	        		
        		
    			var strDeskStartDtTm = moment(reservation.get('deskStartDt')).format("YYYY-MM-DD") + reservation.get('deskStartTm');
    			var strDeskEndDtTm = moment(reservation.get('deskEndDt')).format("YYYY-MM-DD") + reservation.get('deskEndTm');

    			var deskStartDtTm = new moment(strDeskStartDtTm, 'YYYY-MM-DD HH:mm:ss');
    			var deskEndDtTm = new moment(strDeskEndDtTm, 'YYYY-MM-DD HH:mm:ss');
    			
    			if (now.isBetween(deskStartDtTm, deskEndDtTm)) {
    				
	        		var deskId = reservation.get('deskId');
	        		
	         		if(data[deskId]) {
						var temp;
						temp = data[deskId] + reservation.get('reservationNum');
						data[deskId] = temp;
	         		}
	         		else {
	         			data[deskId] = reservation.get('reservationNum');	
	         		}
    			}

         	});
        	
        	_.each(DeskList.models, function(desk){
        		var deskId = desk.get('deskId');
        		
        		if(data[deskId]) {
        			var deskMax = desk.get('deskMax');	
    				if(deskMax == 1) {
    					$('#' + deskId + '.desk .reservationNum').html("");
    					
    				} else {
    					$('#' + deskId + '.desk .reservationNum').html(data[deskId] + '/' + deskMax);    					    					
    				}
        		} else {
        			$('#' + deskId + '.desk .reservationNum').html("");
        			
        		}

        	});        	
            
        },
        goMemberPage: function(e) {
            location.assign(ctxRoot + 'branch/' + [[${branch.branchId}]] + '/members?action=newMember');
        },
        formNewMember: function(e) {
        	var $modal = $('#modal-order-form');
	        $modal.modal('toggle');
        	
            var data = new MemberModel().toJSON();
            data['flag']  =  true; 
            data['emailText'] = '';
            data['emailAdd'] = '';
            var bodyHtml = this.templateForNewMemberForm(data);
            
            var schools = new Bloodhound({
                datumTokenizer: Bloodhound.tokenizers.whitespace,
                queryTokenizer: Bloodhound.tokenizers.whitespace,
                prefetch: ctxRoot + 'api/v1/branch/' + [[${branch.branchId}]] + '/schools',

            });

            $('#modal-new-member-form')
            .one('show.bs.modal', function(e) {
                var $modal = $(this);
                $modal.find('.modal-title').html('새 회원');
                $modal.find('.modal-body').html(bodyHtml);

                /*
                // 다음 회원번호
                getMembersNextNo([[${branch.branchId}]], function(data){
                    $modal.find('[name=no]').val(data);

                });
                */

                $modal.find('.datepicker').datepicker({ language: 'ko', autoclose: true, startView: 'years', });

                $modal.find('.typeahead').typeahead(null, {
                    name: 'school',
                    source: schools,
                    classNames: {
                        input: 'form-control',
                    },
                });

                $modal.find('[name=tel]').on('change', function() {
                    var no = $(this).val().replace(/-/g, '').substr(-4, 4);
                    $('#modal-new-member-form').find('[name=no]').val(no);


                });
                $modal.find('.chosen').chosen({width: "100%"});
            })
            .one('shown.bs.modal', function(e) {
                var $modal = $(this);
                $modal.find('[name=name]').focus();

                $modal.find('form').on('submit', function(e) {
                    e.preventDefault();

                });

				// 회원번호 조회
// 				var memberNo = [];
//                 getMembersNo([[${branch.branchId}]], function(data){
//                 	memberNo = data;
//                 });
                
                $.validator.addMethod(
                	'chkDuplicationForMemberno', function (value, element) {	
                   		
                		var member = MemberList.findWhere({no: value});
       	            			if(member) return false;
       	            			else {
       	            				return true;
       	            			} 	
		            		
		                	}, '회원번호가 이미 등록 되어있습니다'
// 		                var temp;
// 		          		$.each(memberNo, function (index, item){
// 		                		if(value == memberNo[index]) {
// 		                			temp = memberNo[index];
// 		                			return false;
// 		                		}
// 		                		else {
// 		                			return true;
// 		                		}	
// 		                	});
// 		          			return (value != temp);
		            		
// 		                	}, '회원번호가 이미 등록 되어있습니다'
		                	
                );
                
             $.validator.addMethod(
            	'chkDuplicationForMembershipNo', function (value, element) {					
            		//var no = $('input[name="membershipNo"]').val();
            		var member = MemberList.findWhere({membershipNo: value});
	            			if ( member ) return false;
	            			else {
	            				return true;
	            			}
		                	}, '멤버쉽 번호가 이미 등록 되어있습니다'
	                	
     		 );
                
                
                $.validator.addMethod(
                    	'chkNumeric', function (value, element) {					
                    		value = value.replace('C', '');
                    		return this.optional(element) || /^[0-9]+$/.test(value);
    		                
    		                	}, '숫자만 사용 가능합니다'
    		                	
                );  
                
        	    $modal.find('form').validate({
        			rules: {
        				no: {        
        					required: true,
        					minlength: 4,
        					chkDuplicationForMemberno: true,        					
        					chkNumeric: true,
        				},
        				membershipNo : {
        					chkDuplicationForMembershipNo: true,
        				},
        				name: {
        					required: true,
        				},
        				tel:{
        					required: true,
        				},
        				
        			},
        			messages: {
        				no: {
        					required: "회원번호를 입력하세요",
        					minlength: "최소 4자리를 입력하세요",
        				},
        				name: {
        					required: "이름을 입력하세요",
        				},
        				tel:{
        					required: "전화번호를 입력하세요",
        				},
        				
        			}
        	    });
        	    
            })                                                      
            .modal();

        },
        saveNewMember: function(e) {
            var values = {};
            var $modal = $('#modal-new-member-form');
            var $inputs = $modal.find(':input');
			var $form = $modal.find('form');
            
			if($form.valid()) {
	            $inputs.each(function(i, element) {
	                var $element = $(element);
	                if ($element.is('[type=radio]')) {
	                    if ($element.is(':checked')) {
	                        values[$element.attr('name')] = $element.val();
	                    }	
	                } 
					else if( $element.is('[type=checkbox]')){
	                	
	                	var chk = $(this).is(":checked");//.attr('checked');
	                   
	                	if(chk){ 
	                
	                    	values[$element.attr('name')] = "1";
	                       
	                    }
	                }
					
					else {
	                    var name = $element.attr('name');
	                    if (!(_.isEmpty(name))) {
	                        values[name] = $element.val();
	
	                    }
	
	                }
	
	            });
				if (values['membershipNo'] == '') values['membershipNo'] = null;
	            MemberList.create(values, {
	                wait : true,
	                success : function (model, response) {
	                    var memberId = response.memberId;
	                    model.set('memberId', memberId);
	                    model.set('insertDt', response.insertDt);
	                    model.set('updateDt', response.updateDt);
	
	                    $modal.modal('hide');
	
	                    var $memberId = $('.modal-desk').find('[name=memberId]');
	                    $memberId.append('<option value="' + memberId + '">' + model.get('no') + ' ' + model.get('name') + '</option>');
	                    $memberId.val(memberId);
	                    $memberId.trigger('chosen:updated');
	
	                    MemberList.fetch();
	
	                }
	
	            });
			}

        },
        saveNewOrder: function(e) {
        	//알림톡 정보
        	 roomName = null;
        	 deskName = null;
        	 memberName = null;
        	 phone_number = null;
        	 school = null;
        	 registration = null;
        	 amount = null;
        	 tempAmount = null;
        	 memberFormFlag = false;
        	 
        	 var $modal = $('#modal-order-form');
        	 //회원 정보 
        	var values = {};
        	
            var $modalMember = $('#member-form');

            var $inputs = $modalMember.find(':input');

 

            
		/////////////////////////////////////////////////////////////////////////////////////////
			
            $inputs.each(function(i, element) {
            	var $element = $(element);
                
                if ($element.is('[type=radio]')) {		                
                	if ($element.is(':checked')) {
                		valuesMember[$element.attr('name')] = $element.val();
                        memberFormFlag = true;
                    }

                }
				else if( $element.is('[type=checkbox]')){
                	var chk = $(this).is(":checked");//.attr('checked');
                   
                	if(chk){ 
                
                		valuesMember[$element.attr('name')] = "1";
                    	memberFormFlag = true;
                       
                    }
                }
				 else {					 
	                var name = $element.attr('name');
                    if (!(_.isEmpty(name))) {
                    	valuesMember[name] = $element.val();
                 	}
                    
                    if ($element.val() != null && $element.val() != '') {
                    	memberFormFlag = true;
                    }
				}

            });

            if (memberFormFlag == false) {
				if (validatorMember != null) {
					validatorMember.resetForm();
				} 
            }
            
            if ($('#memberId').val() != "" ) {
            	memberOrderFlag = true;
            } else if ($('#memberId').val() != "" && memberFormFlag == false) {
            	
				if (validatorOrder != null) {
					validatorOrder.valid();
				}
            }
 	 
            
			if (validatorOrder != null && memberFormFlag == true) {
				$('#memberId').rules('remove');	
			} else if (validatorOrder != null && memberFormFlag == false && memberOrderFlag == false) {
				$('#memberId').rules('add', 'required');	
			}
			
			
			
        	//var values = {};
            
            //var $modal = $('.modal-desk');
            var $inputs = $modal.find(':input');
			var $form = $modal.find('form');
		
			

								
			validatorOrder = $('#formNewOrderAdd').validate({
				
				submitHandler: function(form) { 					

                	$inputs.each(function(i, element) {
	                var $element = $(element);
	                if ($element.is('[type=radio]')) {
	                    if ($element.is(':checked')) {
	                        values[$element.attr('name')] = $element.val();
	                    }
	
	                } else {
	                    var name = $element.attr('name');
	                    if (!(_.isEmpty(name))) {
	                        values[name] = $element.val();
	
	                    }
	
	                }
	            });
	
				
				var tempAmount = values['payAmount']; //알림톡을 위한 변수                 	
	            values['payAmount'] = values['payAmount'].replace(/,/g, '');
	            values['payInOutType'] = 20; //임시
	            
                
 	           	amount = values['payAmount']; 
 	           	registration = '신규';

 	           var memberList = MemberList.filter({ memberId: values['memberId']});
	            if (memberList[0] != null) {
	            	values['no'] = memberList[0].get('no');
	            	if (memberList[0].get('name') != null) {
	            		memberName = memberList[0].get('name');
	            	}
	           		if (memberList[0].get('telParent') != null) {
	            		phone_number = memberList[0].get('telParent');	//고객용
	           		}
	           		if (memberList[0].get('school') != null || memberList[0].get('school') != '') {
	           			school = memberList[0].get('school');
	           		}
	           		else {
	           			school = '미입력';
	           		}
	            }
	           
				if (values['deskId'] == "") { //좌석지정을 안할 경우
                	roomName = '지정안함';
     	            deskName = '지정안함';
     	            
					//중복데이터 구분
	 	            var reservations = ReservationList.filter({ memberId: values['memberId'], deskId: "" });
	    			
	 	           	//예약이 있는 경우
	                if (reservations.length > 0) {
	      				//var reservationDeskStartDt = makeDateFormat($('#deskStartDt').val()); //함수호출
	      				//입력된 StartDt	      				
	      				var inpuStartDt = $modal.find('[name=deskStartDt]').val();
	      				var dateStartDt = new Date(inpuStartDt*1);
	      				var reservationDeskStartDt = moment(dateStartDt).format('YYYY-MM-DD');

	 					//입력된 EndDt
	      				var inpuEndDt = $modal.find('[name=deskEndDt]').val();
	      				var dateEndDt = new Date(inpuEndDt*1);
	      				var reservationDeskEndDt = moment(dateEndDt).format('YYYY-MM-DD');
						
		    			var valuesDeskStartDtTm = new moment(reservationDeskStartDt + values['deskStartTm'], 'YYYY-MM-DD HH:mm:ss');
		    			var valuesDeskEndDtTm = new moment(reservationDeskEndDt + values['deskEndTm'], 'YYYY-MM-DD HH:mm:ss');
		    			
	                	var now = moment();
	                	var reservationId = []; //겹치는 날짜의 reservationId가 들어가는 변수
						reservations.forEach(function(item) {
							var reservationTemp;
							var reservation = item;
							
			    			var strDeskStartDtTm = moment(reservation.get('deskStartDt')).format("YYYY-MM-DD") + reservation.get('deskStartTm');
			    			var strDeskEndDtTm = moment(reservation.get('deskEndDt')).format("YYYY-MM-DD") + reservation.get('deskEndTm');
	
			    			var deskStartDtTm = new moment(strDeskStartDtTm, 'YYYY-MM-DD HH:mm:ss');
			    			var deskEndDtTm = new moment(strDeskEndDtTm, 'YYYY-MM-DD HH:mm:ss');
			    			
			    			if (deskStartDtTm.isSame(valuesDeskStartDtTm)) {	    				
			    				reservationId.push(reservation.get('reservationId'));
			    				return false;
			    			}
	
			    			else if (deskStartDtTm.isSame(valuesDeskEndDtTm)) {    				
			    				reservationId.push(reservation.get('reservationId'));
			    				return false;
			    			}
	
			    			else if (deskEndDtTm.isSame(valuesDeskStartDtTm)) {
			    				reservationId.push(reservation.get('reservationId'));
			    				return false;
			    			}
			    			
			    			else if (deskEndDtTm.isSame(valuesDeskEndDtTm)) {
			    				reservationId.push(reservation.get('reservationId'));
			    				return false;
			    			}
			    			
			    			else if (deskStartDtTm.isBetween(valuesDeskStartDtTm, valuesDeskEndDtTm)) { 
			    				reservationId.push(reservation.get('reservationId'));
			    				return false;
	 		    			}
	 		    			else if (deskEndDtTm.isBetween(valuesDeskStartDtTm, valuesDeskEndDtTm)) { 
	 		    				reservationId.push(reservation.get('reservationId'));
	 		    				return false;
			    			}
	
	 		    			else if (valuesDeskStartDtTm.isBetween(deskStartDtTm, deskEndDtTm)) { 
	 		    				reservationId.push(reservation.get('reservationId'));
	 		    				return false;
			    			}
			    			
	 		    			else if (valuesDeskEndDtTm.isBetween(deskStartDtTm, deskEndDtTm)) { 
	 		    				reservationId.push(reservation.get('reservationId'));
	 		    				return false;
			    			}
	 		    			else { //안겹침
	 		    			}
							
						});
	                	
	                	if (reservationId.length > 0) { //존재한다면 겹치는 등록이 있음
	                		alert('이 회원은 해당 시간에 이미 지정되지 않은 좌석에 등록되어 있습니다');
	                	}
	                	else {
							if ( memberOrderFlag == true) {
								SaveNewOrder(values, OrderList, ReservationList, PayList);
							} else {
		                		if (memberFormFlag == true) {
		                			if ( $('#member-form').valid() == false) {
		                				$('#member-form').valid();
		                			}
		                			else {
			                			MemberList.create(valuesMember, {
				        	                wait : true,
				        	                success : function (model, response) {
				        	                    var memberId = response.memberId;
				        	                    model.set('memberId', memberId);
				        	                    model.set('insertDt', response.insertDt);
				        	                    model.set('updateDt', response.updateDt);

				        	                    values['memberId'] = memberId;
				        	                    //valuesMember['memberId'] = memberId;
				        	                    
				        	                    $modal.modal('hide');
				        	
				        	                    var $memberId = $('.modal-desk').find('[name=memberId]');
				        	                    $memberId.append('<option value="' + memberId + '">' + model.get('no') + ' ' + model.get('name') + '</option>');
				        	                    $memberId.val(memberId);
				        	                    $memberId.trigger('chosen:updated');
				        	
				        	                    MemberList.fetch();
				        	                    
				        	                    var memberList = MemberList.filter({ memberId: values['memberId']});
				        	    	            if (memberList[0] != null) {
				        	    	            	if (memberList[0].get('name') != null) {
				        	    	            		memberName = memberList[0].get('name');
				        	    	            	}
				        	    	           		if (memberList[0].get('telParent') != null) {
				        	    	            		phone_number = memberList[0].get('telParent');	//고객용
				        	    	           		}
				        	    	           		if (memberList[0].get('school') != null || memberList[0].get('school') != '') {
				        	    	           			school = memberList[0].get('school');
				        	    	           		}
				        	    	           		else {
				        	    	           			school = '미입력';
				        	    	           		}
				        	    	            }
				        	                    
				        	                    SaveNewOrder(values, OrderList, ReservationList, PayList);
				        
				        	                }		        	
				        	         });	                				
		                			}
		                			
		                		} else {
		                			SaveNewOrder(values, OrderList, ReservationList, PayList);	
		                		}
							}
	                		
   		
	                	}
	                }
	                else {	                	
						if ( memberOrderFlag == true) {
							SaveNewOrder(values, OrderList, ReservationList, PayList);
						} else {
	                		if (memberFormFlag == true) {
	                			if ( $('#member-form').valid() == false) {
	                				$('#member-form').valid();
	                			}
	                			else {
		                			MemberList.create(valuesMember, {
			        	                wait : true,
			        	                success : function (model, response) {
			        	                    var memberId = response.memberId;
			        	                    model.set('memberId', memberId);
			        	                    model.set('insertDt', response.insertDt);
			        	                    model.set('updateDt', response.updateDt);

			        	                    values['memberId'] = memberId;
			        	                    //valuesMember['memberId'] = memberId;
			        	                    
			        	                    $modal.modal('hide');
			        	
			        	                    var $memberId = $('.modal-desk').find('[name=memberId]');
			        	                    $memberId.append('<option value="' + memberId + '">' + model.get('no') + ' ' + model.get('name') + '</option>');
			        	                    $memberId.val(memberId);
			        	                    $memberId.trigger('chosen:updated');
			        	
			        	                    MemberList.fetch();
			        	                    
			        	                    var memberList = MemberList.filter({ memberId: values['memberId']});
			        	    	            if (memberList[0] != null) {
			        	    	            	if (memberList[0].get('name') != null) {
			        	    	            		memberName = memberList[0].get('name');
			        	    	            	}
			        	    	           		if (memberList[0].get('telParent') != null) {
			        	    	            		phone_number = memberList[0].get('telParent');	//고객용
			        	    	           		}
			        	    	           		if (memberList[0].get('school') != null || memberList[0].get('school') != '') {
			        	    	           			school = memberList[0].get('school');
			        	    	           		}
			        	    	           		else {
			        	    	           			school = '미입력';
			        	    	           		}
			        	    	            }
			        	    	            
			        	                    SaveNewOrder(values, OrderList, ReservationList, PayList);
			        	
			        	                }		        	
			        	         });	                				
	                			}
	                			
	                		} else {
	                			SaveNewOrder(values, OrderList, ReservationList, PayList);	
	                		}
						}
	                
	                }
				
				
				
				}
				else { //좌석지정을 할 경우
		            //중복데이터 구분
	 	            var reservations = ReservationList.filter({ deskId: values['deskId'] });
	    			
     	           var deskList = DeskList.filter({ deskId: values['deskId']}); 	            
     	            if (deskList[0] != null) {
     	            	if (deskList[0].get('deskId') != null) {
	     	            	var roomList = RoomList.filter({ roomId: deskList[0].get('roomId')});
	     	            	if (roomList[0] != null || roomList[0] != '') {
	     	            		roomName = roomList[0].get('name');
	     	            	}
	     	            	else {
	     	            		roomName = '미입력';
	     	            	}
     	            	}
     	            	if (deskList[0].get('name') != null || deskList[0] != '') {
     	           			deskName = deskList[0].get('name');
     	            	}
     	            	else {
     	            		deskName = '미입력';
     	            	}
     	            }      
	     	            
	 	           	//예약이 있는 경우
	                if (reservations.length > 0) {
	      				//var reservationDeskStartDt = makeDateFormat($('#deskStartDt').val()); //함수호출
	      				//입력된 StartDt	      				
	      				var inpuStartDt = $modal.find('[name=deskStartDt]').val();
	      				var dateStartDt = new Date(inpuStartDt*1);
	      				var reservationDeskStartDt = moment(dateStartDt).format('YYYY-MM-DD');

	 					//입력된 EndDt
	      				var inpuEndDt = $modal.find('[name=deskEndDt]').val();
	      				var dateEndDt = new Date(inpuEndDt*1);
	      				var reservationDeskEndDt = moment(dateEndDt).format('YYYY-MM-DD');
						
		    			var valuesDeskStartDtTm = new moment(reservationDeskStartDt + values['deskStartTm'], 'YYYY-MM-DD HH:mm:ss');
		    			var valuesDeskEndDtTm = new moment(reservationDeskEndDt + values['deskEndTm'], 'YYYY-MM-DD HH:mm:ss');
		    			
	                	var now = moment();
	                	var reservationId = []; //겹치는 날짜의 reservationId가 들어가는 변수
						reservations.forEach(function(item) {

							var reservationTemp;
							var reservation = item;
							if (branchType == 20 && reservation.get('checkoutYn') == 0) { // 퇴실처리한 데이터는 비교대상에서 제외
				    			var strDeskStartDtTm = moment(reservation.get('deskStartDt')).format("YYYY-MM-DD") + reservation.get('deskStartTm');
				    			var strDeskEndDtTm = moment(reservation.get('deskEndDt')).format("YYYY-MM-DD") + reservation.get('deskEndTm');
		
				    			var deskStartDtTm = new moment(strDeskStartDtTm, 'YYYY-MM-DD HH:mm:ss');
				    			var deskEndDtTm = new moment(strDeskEndDtTm, 'YYYY-MM-DD HH:mm:ss');
				    			
				    			if (deskStartDtTm.isSame(valuesDeskStartDtTm)) {	    				
				    				reservationId.push(reservation.get('reservationId'));
				    			}
		
				    			else if (deskStartDtTm.isSame(valuesDeskEndDtTm)) {    				
				    				reservationId.push(reservation.get('reservationId'));
				    			}
		
				    			else if (deskEndDtTm.isSame(valuesDeskStartDtTm)) {
				    				reservationId.push(reservation.get('reservationId'));
				    			}
				    			
				    			else if (deskEndDtTm.isSame(valuesDeskEndDtTm)) {
				    				reservationId.push(reservation.get('reservationId'));
				    			}
				    			
				    			else if (deskStartDtTm.isBetween(valuesDeskStartDtTm, valuesDeskEndDtTm)) { //날짜가 겹치면
				    				reservationId.push(reservation.get('reservationId'));
		 		    			}
		 		    			else if (deskEndDtTm.isBetween(valuesDeskStartDtTm, valuesDeskEndDtTm)) { //시작날짜가 겹치지 않으면 end날짜와 다시한번 조회
		 		    				reservationId.push(reservation.get('reservationId')); 		    					
				    			}
		
		 		    			else if (valuesDeskStartDtTm.isBetween(deskStartDtTm, deskEndDtTm)) { 
		 		    				reservationId.push(reservation.get('reservationId')); 		    					
				    			}
				    			
		 		    			else if (valuesDeskEndDtTm.isBetween(deskStartDtTm, deskEndDtTm)) { 
		 		    				reservationId.push(reservation.get('reservationId')); 		    					
				    			}
		 		    			else { //안겹침
		 		    			}
							}
						});
						
	                	var temp = 0;
						reservationId.forEach(function(item) {
						var reservationTemp = ReservationList.filter({ reservationId: item });
	                	temp++;
	                	
	                	});					
	                	//좌석의 deskMax(최대수용인원) 체크
	     	            var deskList = DeskList.filter({ deskId: values['deskId']});
	     	            var deskMax = deskList[0].get('deskMax');
	     	           	if (temp >= deskMax) {
	     	           		alert('해당 시간에는 이미 좌석이 등록되어 있습니다');
	     	           	}
	     	           	else {
							if ( memberOrderFlag == true) {
								SaveNewOrder(values, OrderList, ReservationList, PayList);
							} else {
		                		if (memberFormFlag == true) {
		                			if ( $('#member-form').valid() == false) {
		                				$('#member-form').valid();
		                			}
		                			else {
			                			MemberList.create(valuesMember, {
				        	                wait : true,
				        	                success : function (model, response) {
				        	                    var memberId = response.memberId;
				        	                    model.set('memberId', memberId);
				        	                    model.set('insertDt', response.insertDt);
				        	                    model.set('updateDt', response.updateDt);

				        	                    values['memberId'] = memberId;
				        	                    //valuesMember['memberId'] = memberId;
				        	                    
				        	                    $modal.modal('hide');
				        	
				        	                    var $memberId = $('.modal-desk').find('[name=memberId]');
				        	                    $memberId.append('<option value="' + memberId + '">' + model.get('no') + ' ' + model.get('name') + '</option>');
				        	                    $memberId.val(memberId);
				        	                    $memberId.trigger('chosen:updated');
				        	
				        	                    MemberList.fetch();
				        	                    
				        	                    var memberList = MemberList.filter({ memberId: values['memberId']});
				        	    	            if (memberList[0] != null) {
				        	    	            	if (memberList[0].get('name') != null) {
				        	    	            		memberName = memberList[0].get('name');
				        	    	            	}
				        	    	           		if (memberList[0].get('telParent') != null) {
				        	    	            		phone_number = memberList[0].get('telParent');	//고객용
				        	    	           		}
				        	    	           		if (memberList[0].get('school') != null || memberList[0].get('school') != '') {
				        	    	           			school = memberList[0].get('school');
				        	    	           		}
				        	    	           		else {
				        	    	           			school = '미입력';
				        	    	           		}
				        	    	            }
				        	    	            
				        	                    SaveNewOrder(values, OrderList, ReservationList, PayList);
				        	
				        	                }		        	
				        	         });	                				
		                			}
		                			
		                		} else {
		                			SaveNewOrder(values, OrderList, ReservationList, PayList);	
		                		}
							}
	     	           	}
	     	            
	                }
	                
	                //예약이 없는경우
	                else {	                	
						if ( memberOrderFlag == true) {
							SaveNewOrder(values, OrderList, ReservationList, PayList);
						} else {
	                		if (memberFormFlag == true) {
	                			if ( $('#member-form').valid() == false) {
	                				$('#member-form').valid();
	                			}
	                			else {
		                			MemberList.create(valuesMember, {
			        	                wait : true,
			        	                success : function (model, response) {
			        	                    var memberId = response.memberId;
			        	                    model.set('memberId', memberId);
			        	                    model.set('insertDt', response.insertDt);
			        	                    model.set('updateDt', response.updateDt);

			        	                    values['memberId'] = memberId;
			        	                    //valuesMember['memberId'] = memberId;
			        	                    
			        	                    $modal.modal('hide');
			        	
			        	                    var $memberId = $('.modal-desk').find('[name=memberId]');
			        	                    $memberId.append('<option value="' + memberId + '">' + model.get('no') + ' ' + model.get('name') + '</option>');
			        	                    $memberId.val(memberId);
			        	                    $memberId.trigger('chosen:updated');
			        	
			        	                    MemberList.fetch();
			        	                    
			        	                    var memberList = MemberList.filter({ memberId: values['memberId']});
			        	    	            if (memberList[0] != null) {
			        	    	            	if (memberList[0].get('name') != null) {
			        	    	            		memberName = memberList[0].get('name');
			        	    	            	}
			        	    	           		if (memberList[0].get('telParent') != null) {
			        	    	            		phone_number = memberList[0].get('telParent');	//고객용
			        	    	           		}
			        	    	           		if (memberList[0].get('school') != null || memberList[0].get('school') != '') {
			        	    	           			school = memberList[0].get('school');
			        	    	           		}
			        	    	           		else {
			        	    	           			school = '미입력';
			        	    	           		}
			        	    	            }
			        	    	            
			        	                    SaveNewOrder(values, OrderList, ReservationList, PayList);
			        	
			        	                }		        	
			        	         });	                				
	                			}
	                			
	                		} else {
	                			SaveNewOrder(values, OrderList, ReservationList, PayList);	
	                		}
						}
	                }
				}
            	},
            	
            	ignore: "not:hidden",
            	rules: {
        			memberId: {            			
        				required: false,
        			},
//         			deskId: {
//         				required: true,
//         			},
        			payType:{                				
        				required: true,
        				number : true,
        			},
        			payAmount: {
        				//min: 1000,
        				chkNumeric : true,
        			}
        			
        		},
        		messages: {
        			memberId: {            	
        	    		required: "회원을 선택하시거나 신규 회원 정보를 입력하세요",
        			},
//         			deskId: {
//         				required: "좌석을 선택하세요",
//         			},
        			payType:{
        				required: "결제 구분을 선택하세요",
        				number : "결제 구분을 선택하세요",
        			},
        			payAmount: {
        				//min: "금액을 선택하세요"        				
        			}
        			
        		}
        		
			});
			
			jQuery.validator.addMethod(
            		'chkNumeric', function (value, element) {
            			value = value.replace(/,/g, '');
            			value = value.replace('C', '');
		                return this.optional(element) || /^[0-9]+$/.test(value);
		                
		                	}, '숫자만 사용 가능합니다'
            );
			
            //$form.submit();
			if ($('#memberId').val() == '' && $(":input:radio[name=payType]:checked").val() == 'no' && memberFormFlag == false ) {
				$("#memberId").rules("add", "required");
				//$('#formNewOrderAdd').submit();
			}
            $('#formNewOrderAdd').submit();
            //$('#member-form').submit();
            
        },
        cancelSaveNewOrder: function(e) {
            var $modal = $('.modal-desk');
			var $form = $modal.find('form');

            $form.get(0).reset();
            $modal.find('.orderForm').show();
           	$modal.find('.newOrderSection').hide();

            $form.find('.chosen').each(function(i) {
                $(this).trigger('chosen:updated');

            });

        },
        formReservation: function(model, ReservationList, MemberList, DeskList, RoomList, PayList, payTypes, flag, branchType, branchId, branchTel) {
        	
        	if(this.currrentFormReservationApp) {
        		this.currrentFormReservationApp.undelegateEvents();
        		this.currrentFormReservationApp.stopListening();
        	}
        	
        	this.currrentFormReservationApp = formReservation(model, ReservationList, MemberList, DeskList, RoomList, PayList, payTypes, flag, branchType, branchId, branchTel);

        },
        goPayPage: function(e) {
            var deskId = DeskList.currentDeskModel.get('deskId');
            location.assign(ctxRoot + 'branch/' + [[${branch.branchId}]] + '/pays?action=newPay&deskId=' + deskId);

        },
        goReservationPage: function(e) {
            var deskId = DeskList.currentDeskModel.get('deskId');
            location.assign(ctxRoot + 'branch/' + [[${branch.branchId}]] + '/reservations?action=newReservation&deskId=' + deskId);

        },
        addOneRoom: function(room) {
            var view = new RoomView({ model: room });

            this.$('#branch-op-list').append(view.render().el);

        },
        resetRoom: function() {
            RoomList.forEach(this.addOneRoom);

        },
        addOneDesk: function(desk) {
            var view = new DeskView({ model: desk });
            
            if(desk.get('roomId')){
            	this.$('#' + desk.get('roomId') + '.room').append(view.render().el);
            }
        },
        resetDesk: function() {
            DeskList.forEach(this.addOneDesk);

        },
        addOneMember: function(member) {
            var view = new MemberView({ model: member });

            this.$('#branch-op-list').append(view.render().el);

        },
        resetMember: function() {
            MemberList.forEach(this.addOneMember);

        },
        addOnePay: function(pay) {
            /*
            var now = moment();
            var deskStartDt = pay.get('deskStartDt');
            var deskEndDt = pay.get('deskEndDt');

            if (now.isBetween(deskStartDt, deskEndDt)) {
                //var view = new PayView({ model: pay });
                //this.$('#' + pay.get('deskId')).find('.members').append(view.render().el);

                var member = MemberList.get(pay.get('memberId'));
                var diff = moment(deskEndDt).diff(moment(), 'days');
                var memberInfo = '<div>' + member.get('no') + '-' + member.get('name') + '[' + diff + ']</div>';
                this.$('#' + pay.get('deskId') + '.desk').find('.members').append(memberInfo);

            }
            */

        },
        resetPay: function() {
            PayList.forEach(this.addOnePay);

        },
        addOneReservation: function(reservation) {        	
        	
        	var branchId = [[${branch.branchId}]];
        	var orderId = reservation.get('memberId');
        	//var orderId = reservation.get('orderId');
            
        	var now = moment();
			var strDeskStartDtTm = moment(reservation.get('deskStartDt')).format("YYYY-MM-DD") + reservation.get('deskStartTm');
			var strDeskEndDtTm = moment(reservation.get('deskEndDt')).format("YYYY-MM-DD") + reservation.get('deskEndTm');

			var deskStartDtTm = new moment(strDeskStartDtTm, 'YYYY-MM-DD HH:mm:ss');
			var deskEndDtTm = new moment(strDeskEndDtTm, 'YYYY-MM-DD HH:mm:ss');
			

				if (now.isBetween(deskStartDtTm, deskEndDtTm)) {
					//현재 등록
		            if(reservation.get('deskId')) {
		            	var view = new DeskReservationView({ model: reservation });
		            	this.$('#' + reservation.get('deskId') + '.desk').find('.reservations').append(view.render().el);
		            	//this.$('#' + reservation.get('deskId') + '.desk').find('.reservations').find('[data-status=to-be-reserved]').hide();	            	
					}
					else {					
						reservation.set("desks", DeskList.toJSON());
						//reservation.set("rooms", RoomList.toJSON());
						var view = new DeskReservationView({ model: reservation });
						this.$('#freeSeat-list').append(view.render().el);
					}
				}
				else {
					
					//예약 등록
					if(reservation.get('deskId')) {
		            	//같은 reservation에 현재 등록이 있으면 예약등록을 출력하지 않는다
		            	var view = new DeskReservationView({ model: reservation });
	 	            	
	 	            	this.$('#' + reservation.get('deskId') + '.desk').find('.reservations').append(view.render().el);
		            	var deskId = reservation.get('deskId');
		            	var reservations = ReservationList.filter({ deskId : deskId});

//	 	            	var reservationStartDt = moment(reservation.get('deskStartDt')+1000000000000000).format("YYYY-MM-DD");
//	 	            	var reservationStartDt2 = new moment(reservationStartDt, 'YYYY-MM-DD HH:mm:ss');
		            	var reservationStartDt = 0;
		            	var reservationId;
		            	
		            	reservations.forEach(function(item) {
							var reservation = item;
							
			    			var strDeskStartDtTm = moment(reservation.get('deskStartDt')).format("YYYY-MM-DD") + reservation.get('deskStartTm');
			    			var strDeskEndDtTm = moment(reservation.get('deskEndDt')).format("YYYY-MM-DD") + reservation.get('deskEndTm');
			    			
			    			var deskStartDtTm = new moment(strDeskStartDtTm, 'YYYY-MM-DD HH:mm:ss');
			    			var deskEndDtTm = new moment(strDeskEndDtTm, 'YYYY-MM-DD HH:mm:ss');
			    			
			    			//this.$('#' + reservation.get('deskId') + '.desk').find('.reservations').find('[data-status=to-be-reserved]').hide();
		    				if (now.isBetween(deskStartDtTm, deskEndDtTm)) {
		    					
		    				}
		    				else {
				    			if (reservationStartDt < deskStartDtTm) {	    					 
			    					reservationStartDt = deskStartDtTm;
			    					reservationId = reservation.get('reservationId');	   
			    					var view = new stateView({ model: reservation });
			    					this.$('#toBeReservation-list').append(view.render().el);		//예약자 리스트
			    				}
		    				}				
						});
		            	
			            if (reservations.length > 1) { //예약데이터가 여러개일 경우 시작날짜가 가장 최근인 데이터를 출력한다
			            	this.$('#' + reservation.get('deskId') + '.desk').find('.reservations').find('[id='+reservationId+']').hide();
						}

					}
					else {
						reservation.set("desks", DeskList.toJSON());
						//reservation.set("rooms", RoomList.toJSON());
						var view = new DeskReservationView({ model: reservation });
						this.$('#freeSeat-list').append(view.render().el);
						
					}
				
				}
			
			
			
        	reservation.reservationsOfOrder = new ReservationListCollection;
            reservation.reservationsOfOrder.url = ctxRoot + 'api/v1/branch/' + branchId + '/orders/' + orderId + '/reservations';
            
            //////////////////////*****************************************************/////////////////////////
            reservation.paysOfOrder = new PayListCollection;
            reservation.paysOfOrder.url = ctxRoot + 'api/v1/branch/' + branchId + '/orders/' + orderId + '/pays';
                      

        },
        addOneReservationAll: function(reservation) {
        	
        
        	/* var branchId = [[${branch.branchId}]];
        	var orderId = reservation.get('memberId');
        	//var orderId = reservation.get('orderId');
            
        	var now = moment();
			var strDeskStartDtTm = moment(reservation.get('deskStartDt')).format("YYYY-MM-DD") + reservation.get('deskStartTm');
			var strDeskEndDtTm = moment(reservation.get('deskEndDt')).format("YYYY-MM-DD") + reservation.get('deskEndTm');

			var deskStartDtTm = new moment(strDeskStartDtTm, 'YYYY-MM-DD HH:mm:ss');
			var deskEndDtTm = new moment(strDeskEndDtTm, 'YYYY-MM-DD HH:mm:ss');
			
			
			if (now.isBetween(deskStartDtTm, deskEndDtTm)) {
				//현재 등록

			}
			else if (now.isAfter(deskEndDtTm)){
				//기간 만료
	            if(reservation.get('deskId')) {
	            	var view = new DeskReservationView({ model: reservation });
	            	this.$('#' + reservation.get('deskId') + '.desk').find('.reservations').append(view.render().el);
	            	//this.$('#' + reservation.get('deskId') + '.desk').find('.reservations').find('[data-status=expired]').hide();	            	
				}
				else {					
					//reservation.set("desks", DeskList.toJSON());
					//reservation.set("rooms", RoomList.toJSON());
					//var view = new DeskReservationView({ model: reservation });
				}
			
			}
        	
        	reservation.reservationsOfOrder = new ReservationListCollection;
            reservation.reservationsOfOrder.url = ctxRoot + 'api/v1/branch/' + branchId + '/orders/' + orderId + '/reservations';
            
            reservation.paysOfOrder = new PayListCollection;
            reservation.paysOfOrder.url = ctxRoot + 'api/v1/branch/' + branchId + '/orders/' + orderId + '/pays';  
            */	
        },
       
        
        resetReservation: function() {
        	//ReservationList.forEach(this.addOneReservation);
        	ReservationList.forEach(this.addOneReservation, this);
        	
        		return this;

        },
        resetReservationAll: function() {
        	ReservationAllList.forEach(this.addOneReservationAll, this);
        	
        		return this;

        },        
        addOneEntry: function(entry) {
            var reservationId = entry.get('reservationId');

            var entryType = entry.get('entryType');                        
                        
            var tempEntry = entry.collection.filter({ memberId : entry.attributes.memberId });                        
                                    
            var cidTemp = tempEntry[0].cid;
            if (cidTemp == entry.cid) {
	            
            	var status;
	            switch(entryType) {
	                case 1:
	                    status = 'in';
	                    break;
	                case 2:
	                    status = 'out';
	                    break;
	                case 3:
	                    status = 'outing';
	                    break;
	                case 4:
	                    status = 'in';
	                    break;
	                default:
	                    return;
	            }
	
	            this.$('[id=' + reservationId + ']').attr('data-status', status)
            }

            var view = new EntryView({ model: entry });

            this.$('#branch-entry-list-body').append(view.render().el);

        },
        resetEntry: function() {
            this.$('#branch-entry-list-body').empty();

            EntryList.forEach(this.addOneEntry);

            this.refreshStats();
            this.reservationNum();

        },
        newReservation: function(){
        	var $modal = $('.modal-desk');
        	
        	var $inputs = $('#member-form').find(':input');
	            $inputs.each(function(i, element) {
	                var $element = $(element);
	                if ($element.is('[type=radio]')) {
	                    if ($element.is(':checked')) {
	                    	$element.prop("checked", false);    
	                	        
	                    }
					}
	                else if( $element.is('[type=checkbox]')){
	                	$element.attr("checked", false);
	                	

	                }
	                else {
	                	$element.val('');	
	                }
	                
	        });
        	
        	$modal.find('.orderForm').hide();        	
        	$modal.find('.newOrderSection').show();
        	
        },
        keyup : function(e) {
        	if ( (e.keyCode >= 96 && e.keyCode <= 105) || (e.keyCode >= 48 && e.keyCode <= 57) ) {
	        	var num = this.$('#payAmount').val(); 
	        	//num = num.replace(/[^0-9]/g,'');
	        	num = num.replace(/[^a-zA-Z0-9]/g,''); 
	        	
	        	num = AddComma(num);
	        	this.$('#payAmount').val(num);
        	}

        },


    });

    var App = new BranchOpView;

    RoomList.reset(JSON.parse([[${roomListJSON}]]));
    DeskList.reset(JSON.parse([[${deskListJSON}]]));
    MemberList.reset(JSON.parse([[${memberListJSON}]]));
    PayList.reset(JSON.parse([[${payListJSON}]]));
    ReservationList.reset(JSON.parse([[${reservationListJSON}]]));
    ReservationAllList.reset(JSON.parse([[${reservationListAllJSON}]]));
    EntryList.reset(JSON.parse([[${entryListJSON}]]));

    var typed_into = false;
        
    
    
    var ReservationList = ReservationList;
    var scannerView = Backbone.View.extend({
        el: $('#membership-card-app'),
        template: _.template($('#membership-card-template').html()),
        templateForNewOrderForm: _.template($('#new-order-form-template').html()),
        templateForMemberForm: _.template($('#member-form-template').html()),
        events: {
        	'click #btn-search-membership' : 'scannerDetected',
        	'scannerDetected' : 'scannerDetected',
        	
        },   
        initialize: function() {
        	this.render();

        	setScannerDetectionConfig(this.$('#membership'), this.$el);

        },
        render: function() {
            this.$el.html(this.template({}));

            return this;

        },
        change: function() {
            this.render();

        },
        keypressMemberShip: function(e) {
        	if (this._timeuotHandler) {
                clearTimeout(this._timeuotHandler);
                this._inputString += String.fromCharCode(e.which);
            } 

            this._timeuotHandler = setTimeout($.proxy(function () {
                if (this._inputString.length <= 3) {
                    this._inputString = '';
                    return;
                }

                this.changeMemberShip();

                this._inputString = '';

            }, this), 20);
        },
        scannerDetected: function() {
        	var no = this.$('#membership').val();
            var member = MemberList.findWhere({membershipNo: no});
            var tempMember = new Array();
            var tempIndex = 0;
            
            if (member == null) {
                member = MemberList.findWhere({no: no});
                if (member == null) {            		
            		MemberList.forEach(function(item) {      
						if (item.attributes.name.indexOf(no) != -1)  {
							member = item;
							tempMember[tempIndex++] = item;
						}
            		});
            		
            		if (member == null) {
	                	alert('등록된 멤버십번호 또는 회원번호가 없습니다');
	                    return;
            		}
                } else { //회원번호로 찾았을 경우
                    this.$('#membership').val('');

                	var memberId = member.get('memberId');
                	var reservation = ReservationList.findWhere({memberId: memberId});
                	$('.reservations #' + reservation.attributes.reservationId + '').trigger('click');
                	return;
                }

            } else {

                this.$('#membership').val('');

            	var memberId = member.get('memberId');
            	var reservation = ReservationList.findWhere({memberId: memberId});
            	$('.reservations #' + reservation.attributes.reservationId + '').trigger('click');
            	return;
            }

            this.$('#membership').val('');

            //var memberId = member.get('memberId');

            var BreakException = {};
            var reservation = null;
            
            try {
	            tempMember.forEach(function(item){
	            	reservation = ReservationList.findWhere({memberId: item.attributes.memberId});
	            	if (reservation != null) throw BreakException;
	            	
	            });
            } catch (e) {
            	if (e !== BreakException) throw e;
            }
            
            
            if (reservation == null) {
            	alert('등록된 내역이 없습니다');
                return;
            }
            else {            
            	var reservationId = reservation.get('reservationId');
            	
            	//deskId가 있을 경우
             	if(reservation.get('deskId')){
        			var now = moment();
             		var strDeskStartDtTm = moment(reservation.get('deskStartDt')).format("YYYY-MM-DD") + reservation.get('deskStartTm');
        			var strDeskEndDtTm = moment(reservation.get('deskEndDt')).format("YYYY-MM-DD") + reservation.get('deskEndTm');

        			var deskStartDtTm = new moment(strDeskStartDtTm, 'YYYY-MM-DD HH:mm:ss');
        			var deskEndDtTm = new moment(strDeskEndDtTm, 'YYYY-MM-DD HH:mm:ss');
        			
        			//등록이 현재 시간에 있는 경우
        			if (now.isBetween(deskStartDtTm, deskEndDtTm)) {
             			$('.reservations #'+reservationId+'').trigger('click');
             			
             			
        			}
        			//등록이 현재 시간보다 과거에 있는 경우
        			//else if (now.isAfter(deskStartDtTm, deskEndDtTm)) {
					else if (now.isAfter(deskEndDtTm)) {        				
        				var deskId = reservation.get('deskId');
        				$('.desk#'+deskId+'').trigger('click');
        				$('.reservation#'+reservationId+'').trigger('click'); 
        	        	
        			}
    				var $modal = $('.modal-desk');
    	            var reservations = ReservationList.filter({ reservationId: reservationId });

    	        	ReservationList.trigger('formReservation', reservations[0], ReservationList, MemberList, DeskList, RoomList, PayList, payTypes, flag, branchType, branchId, branchTel);

    	            var memberId = reservations[0].get('memberId');        	            
    	        	var memberData = MemberList.get(''+memberId+'').toJSON();
    	        	var memberHtml = this.templateForMemberForm(memberData);
    	        	
    	        	$modal.find('.member').html(memberHtml);
             	}
            	//deskId가 없을 경우
            	else {
            		
            		$('#btn-form-freeSeat').trigger('click');
            	}
            	            	
            }
            

        },

    });
    
    var scannerApp = new scannerView;
    
    scannerDetection();
    
    
    var stateListView = Backbone.View.extend({
    	el: $('#footer'),
    	templateForStats: _.template($('#stats-template').html()),
        events: {
        	'click #reserved' : 'reserved',
        	'click #toBeReserved' : 'toBeReserved',
        	'click #out' : 'out',
        	'click #in' : 'in',
        	'click #outing' : 'outing',
        	'click #below-7' : 'below7',
        	'click #below-4' : 'below4',
        	'click #below-1' : 'below1',
        	'click #receivable' : 'receivable',
        },
        render: function() {
        	return this;
        },
        reserved: function() { //미방문
        	$('#modal-list-form').one('show.bs.modal', function(e) {
        		var $modal = $(this);
        		$modal.find('.modal-title').html('미방문 리스트');
        		$modal.find('#reserved-list').show();
        		
        		$modal.find('#toBeReservation-list').hide();
        		$modal.find('#out-list').hide();
        		$modal.find('#in-list').hide();
        		$modal.find('#outing-list').hide();
        		$modal.find('#below-7-list').hide();
        		$modal.find('#below-4-list').hide();
        		$modal.find('#below-1-list').hide();
        		$modal.find('#receivable-list').hide();
				
        		
        	})
        	.one('hidden.bs.modal', function(e) {
        		//location.reload();
        	})        	
        	.modal();
        },
        toBeReserved: function() { //미방문
        	$('#modal-list-form').one('show.bs.modal', function(e) {
        		var $modal = $(this);
        		$modal.find('.modal-title').html('예약 리스트');
        		$modal.find('#toBeReservation-list').show();
        		
        		$modal.find('#reserved-list').hide();
        		$modal.find('#out-list').hide();
        		$modal.find('#in-list').hide();
        		$modal.find('#outing-list').hide();
        		$modal.find('#below-7-list').hide();
        		$modal.find('#below-4-list').hide();
        		$modal.find('#below-1-list').hide();
        		$modal.find('#receivable-list').hide();
        		
        		
        	})
        	.one('hidden.bs.modal', function(e) {
        		//location.reload();
        	})        	
        	.modal();
        },
        out: function() { //학습 후 퇴실
        	$('#modal-list-form').one('show.bs.modal', function(e) {
        		var $modal = $(this);
        		$modal.find('.modal-title').html('학습 후 퇴실 리스트');
        		$modal.find('#out-list').show();
        		
        		$modal.find('#toBeReservation-list').hide();        		
        		$modal.find('#reserved-list').hide();        		
        		$modal.find('#in-list').hide();
        		$modal.find('#outing-list').hide();
        		$modal.find('#below-7-list').hide();
        		$modal.find('#below-4-list').hide();
        		$modal.find('#below-1-list').hide();
        		$modal.find('#receivable-list').hide();
        		
        		
        	})
        	.one('hidden.bs.modal', function(e) {
        		//location.reload();
        	})        	
        	.modal();
        },
        in: function() { //학습중
        	$('#modal-list-form').one('show.bs.modal', function(e) {
        		var $modal = $(this);
        		$modal.find('.modal-title').html('학습중 리스트');
        		$modal.find('#in-list').show();
        		
        		$modal.find('#toBeReservation-list').hide();        		
        		$modal.find('#reserved-list').hide();
        		$modal.find('#out-list').hide();        		
        		$modal.find('#outing-list').hide();
        		$modal.find('#below-7-list').hide();
        		$modal.find('#below-4-list').hide();
        		$modal.find('#below-1-list').hide();
        		$modal.find('#receivable-list').hide();
        		
        		
        	})
        	.one('hidden.bs.modal', function(e) {
        		//location.reload();
        	})        	
        	.modal();
        },
        outing: function() { //휴식
        	$('#modal-list-form').one('show.bs.modal', function(e) {
        		var $modal = $(this);
        		$modal.find('.modal-title').html('휴식 리스트');
        		$modal.find('#outing-list').show();
        		
        		$modal.find('#toBeReservation-list').hide();        	
        		$modal.find('#reserved-list').hide();
        		$modal.find('#out-list').hide();
        		$modal.find('#in-list').hide();        		
        		$modal.find('#below-7-list').hide();
        		$modal.find('#below-4-list').hide();
        		$modal.find('#below-1-list').hide();
        		$modal.find('#receivable-list').hide();
        		
        		
        	})
        	.one('hidden.bs.modal', function(e) {
        		//location.reload();
        	})
        	.modal();
        },
        below7: function() { //잔여 7일
        	$('#modal-list-form').one('show.bs.modal', function(e) {
        		var $modal = $(this);
        		$modal.find('.modal-title').html('잔여7일 리스트');
        		$modal.find('#below-7-list').show();
        		
        		$modal.find('#toBeReservation-list').hide();        		
        		$modal.find('#reserved-list').hide();
        		$modal.find('#out-list').hide();
        		$modal.find('#in-list').hide();
        		$modal.find('#outing-list').hide();        		
        		$modal.find('#below-4-list').hide();
        		$modal.find('#below-1-list').hide();
        		$modal.find('#receivable-list').hide();
        		
        		
        	})
        	.one('hidden.bs.modal', function(e) {
        		//location.reload();
        	})
        	.modal();
        },
        below4: function() { //잔여 4일
        	$('#modal-list-form').one('show.bs.modal', function(e) {
        		var $modal = $(this);
        		$modal.find('.modal-title').html('잔여4일 리스트');
        		$modal.find('#below-4-list').show();
        		
        		$modal.find('#toBeReservation-list').hide();        		
        		$modal.find('#reserved-list').hide();
        		$modal.find('#out-list').hide();
        		$modal.find('#in-list').hide();
        		$modal.find('#outing-list').hide();
        		$modal.find('#below-7-list').hide();        		
        		$modal.find('#below-1-list').hide();
        		$modal.find('#receivable-list').hide();
        		
        		
        	})
        	.one('hidden.bs.modal', function(e) {
        		//location.reload();
        	})
        	.modal();
        },
        below1: function() { //잔여 1일
        	$('#modal-list-form').one('show.bs.modal', function(e) {
        		var $modal = $(this);
        		$modal.find('.modal-title').html('잔여1일 리스트');
        		$modal.find('#below-1-list').show();
        		
        		$modal.find('#toBeReservation-list').hide();        		
        		$modal.find('#reserved-list').hide();
        		$modal.find('#out-list').hide();
        		$modal.find('#in-list').hide();
        		$modal.find('#outing-list').hide();
        		$modal.find('#below-7-list').hide();
        		$modal.find('#below-4-list').hide();        		
        		$modal.find('#receivable-list').hide();
        		
        		
        	})
        	.one('hidden.bs.modal', function(e) {
        		//location.reload();
        	})
        	.modal();
        },
        receivable: function() { //미수금
        	$('#modal-list-form').one('show.bs.modal', function(e) {
        		var $modal = $(this);
        		$modal.find('.modal-title').html('미수금 리스트');
        		$modal.find('#receivable-list').show();
        		
        		$modal.find('#toBeReservation-list').hide();        		
        		$modal.find('#reserved-list').hide();
        		$modal.find('#out-list').hide();
        		$modal.find('#in-list').hide();
        		$modal.find('#outing-list').hide();
        		$modal.find('#below-7-list').hide();
        		$modal.find('#below-4-list').hide();
        		$modal.find('#below-1-list').hide();
        		
        		
        		
        	})
        	.one('hidden.bs.modal', function(e) {
        		//location.reload();
        	})
        	.modal();
        },
        
        
        
    });
    
    var stateListApp = new stateListView;
    

});



// ]]></script>
<script th:src='@{/common/api_branch_room.js}'></script>
<script th:src='@{/common/api_branch_desk.js}'></script>
<script th:src='@{/common/api_branch_member.js}'></script>
<script th:src='@{/common/api_branch_pay.js}'></script>
<script th:src='@{/common/api_branch_order.js}'></script>
<script th:src='@{/common/api_branch_reservation.js}'></script>
<script th:src='@{/common/api_branch_entry.js}'></script>
<!-- DatePicker : https://bootstrap-datepicker.readthedocs.io/en/latest/ -->
<script
	th:src='@{/lib/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js}'></script>
<script charset='UTF-8'
	th:src='@{/lib/bootstrap-datepicker/dist/locales/bootstrap-datepicker.ko.min.js}'></script>
<link rel='stylesheet'
	th:href='@{/lib/bootstrap-datepicker/dist/css/bootstrap-datepicker3.min.css}' />
<!-- Chosen : https://github.com/harvesthq/chosen -->
<link rel='stylesheet' th:href='@{/lib/chosen/chosen.css}' />
<script th:src='@{/lib/chosen/chosen.jquery.js}'></script>
<!-- Validation : https://jqueryvalidation.org/documentation/ -->
<script th:src='@{/lib/jquery-validation/dist/jquery.validate.min.js}'></script>
<!-- typeahead.js : https://github.com/twitter/typeahead.js -->
<script th:src='@{/lib/typeahead.js/dist/typeahead.bundle.min.js}'></script>
<!-- Clockpicker : https://weareoutman.github.io/clockpicker/ -->
<script th:src='@{/lib/clockpicker/dist/jquery-clockpicker.min.js}'></script>
<!-- <link rel="stylesheet" th:href='@{/lib/clockpicker/assets/css/bootstrap.min.css}' /> -->
<link rel='stylesheet'
	th:href='@{/lib/clockpicker/dist/jquery-clockpicker.min.css}' />
<!-- ScannerDetection : http://a.kabachnik.info/jquery-scannerdetection-tutorial.html -->
<script th:src='@{/common/scannerDetection/jquery.scannerdetection.js}'> </script>
